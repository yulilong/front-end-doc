<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React Hooks详解 | 前端知识</title>
    <meta name="description" content="一个总结前端知识的文档网站">
    <link rel="icon" href="/logo.png">
  <script defer="defer" src="/static/jquery.slim.min.js"></script>
  <script defer="defer" src="/static/jquery.fancybox.min.js"></script>
  <link defer="defer" rel="stylesheet" type="text/css" href="/static/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.76f153c4.css" as="style"><link rel="preload" href="/assets/js/app.2afb8482.js" as="script"><link rel="preload" href="/assets/js/18.958e91d3.js" as="script"><link rel="prefetch" href="/assets/js/10.0ef1013d.js"><link rel="prefetch" href="/assets/js/100.59669d01.js"><link rel="prefetch" href="/assets/js/101.741c2686.js"><link rel="prefetch" href="/assets/js/102.47149e7d.js"><link rel="prefetch" href="/assets/js/103.f1eaf177.js"><link rel="prefetch" href="/assets/js/104.f23808ff.js"><link rel="prefetch" href="/assets/js/105.f5bdad72.js"><link rel="prefetch" href="/assets/js/106.b8157b10.js"><link rel="prefetch" href="/assets/js/107.a275a057.js"><link rel="prefetch" href="/assets/js/108.4906ec1c.js"><link rel="prefetch" href="/assets/js/109.b21c5677.js"><link rel="prefetch" href="/assets/js/11.3ee5972a.js"><link rel="prefetch" href="/assets/js/110.11790a6f.js"><link rel="prefetch" href="/assets/js/111.519e46a2.js"><link rel="prefetch" href="/assets/js/112.856c72b2.js"><link rel="prefetch" href="/assets/js/113.1a9718fd.js"><link rel="prefetch" href="/assets/js/114.98562c57.js"><link rel="prefetch" href="/assets/js/115.dd09f294.js"><link rel="prefetch" href="/assets/js/116.3e697856.js"><link rel="prefetch" href="/assets/js/117.9ed54de6.js"><link rel="prefetch" href="/assets/js/118.837075a7.js"><link rel="prefetch" href="/assets/js/119.eeb7356e.js"><link rel="prefetch" href="/assets/js/12.ef92ad8b.js"><link rel="prefetch" href="/assets/js/120.d76e8c70.js"><link rel="prefetch" href="/assets/js/121.5490f8be.js"><link rel="prefetch" href="/assets/js/122.bf95df47.js"><link rel="prefetch" href="/assets/js/123.1246f4df.js"><link rel="prefetch" href="/assets/js/124.1b332371.js"><link rel="prefetch" href="/assets/js/125.e968eefc.js"><link rel="prefetch" href="/assets/js/126.41b0b42d.js"><link rel="prefetch" href="/assets/js/127.8d532027.js"><link rel="prefetch" href="/assets/js/128.e3d0dd45.js"><link rel="prefetch" href="/assets/js/129.2eec7742.js"><link rel="prefetch" href="/assets/js/13.5d83ca59.js"><link rel="prefetch" href="/assets/js/130.184a5326.js"><link rel="prefetch" href="/assets/js/131.55d5602a.js"><link rel="prefetch" href="/assets/js/132.0739ad32.js"><link rel="prefetch" href="/assets/js/133.eb282834.js"><link rel="prefetch" href="/assets/js/134.9df36c58.js"><link rel="prefetch" href="/assets/js/135.6d3b3c22.js"><link rel="prefetch" href="/assets/js/136.f6fc5239.js"><link rel="prefetch" href="/assets/js/137.13c0c004.js"><link rel="prefetch" href="/assets/js/138.d9558cc8.js"><link rel="prefetch" href="/assets/js/139.450241fe.js"><link rel="prefetch" href="/assets/js/14.bb2ca207.js"><link rel="prefetch" href="/assets/js/140.e1bf74b6.js"><link rel="prefetch" href="/assets/js/141.b02477b9.js"><link rel="prefetch" href="/assets/js/142.2d68a06d.js"><link rel="prefetch" href="/assets/js/143.c47820a5.js"><link rel="prefetch" href="/assets/js/144.17e6f31d.js"><link rel="prefetch" href="/assets/js/145.2e8592c6.js"><link rel="prefetch" href="/assets/js/146.720781fb.js"><link rel="prefetch" href="/assets/js/147.bf3ed75b.js"><link rel="prefetch" href="/assets/js/148.9505073e.js"><link rel="prefetch" href="/assets/js/149.f9dd6c7c.js"><link rel="prefetch" href="/assets/js/15.16c14ea6.js"><link rel="prefetch" href="/assets/js/150.90a127d0.js"><link rel="prefetch" href="/assets/js/151.9d50afd2.js"><link rel="prefetch" href="/assets/js/152.fbecf0f6.js"><link rel="prefetch" href="/assets/js/153.32c2bb94.js"><link rel="prefetch" href="/assets/js/154.3c5424d9.js"><link rel="prefetch" href="/assets/js/155.4587c969.js"><link rel="prefetch" href="/assets/js/156.b40288c2.js"><link rel="prefetch" href="/assets/js/157.edd410f1.js"><link rel="prefetch" href="/assets/js/158.ada22e21.js"><link rel="prefetch" href="/assets/js/159.ae4e1769.js"><link rel="prefetch" href="/assets/js/16.70266c95.js"><link rel="prefetch" href="/assets/js/160.1c2e95e3.js"><link rel="prefetch" href="/assets/js/161.764559ae.js"><link rel="prefetch" href="/assets/js/162.f3834de5.js"><link rel="prefetch" href="/assets/js/163.17919df8.js"><link rel="prefetch" href="/assets/js/164.a9b1a7d4.js"><link rel="prefetch" href="/assets/js/165.e649e97a.js"><link rel="prefetch" href="/assets/js/166.02532372.js"><link rel="prefetch" href="/assets/js/167.7d112130.js"><link rel="prefetch" href="/assets/js/168.90c0dfba.js"><link rel="prefetch" href="/assets/js/169.d313ed3c.js"><link rel="prefetch" href="/assets/js/17.1f842ac0.js"><link rel="prefetch" href="/assets/js/170.4d971d67.js"><link rel="prefetch" href="/assets/js/171.6a5296d2.js"><link rel="prefetch" href="/assets/js/172.388c5f2d.js"><link rel="prefetch" href="/assets/js/173.8724128a.js"><link rel="prefetch" href="/assets/js/174.0bee9e04.js"><link rel="prefetch" href="/assets/js/175.0e539288.js"><link rel="prefetch" href="/assets/js/176.69aebc77.js"><link rel="prefetch" href="/assets/js/177.e321e16b.js"><link rel="prefetch" href="/assets/js/178.7a6767c2.js"><link rel="prefetch" href="/assets/js/179.b1cd3d26.js"><link rel="prefetch" href="/assets/js/180.aa4e26e5.js"><link rel="prefetch" href="/assets/js/181.373fea9f.js"><link rel="prefetch" href="/assets/js/182.00faf1e3.js"><link rel="prefetch" href="/assets/js/183.f5084718.js"><link rel="prefetch" href="/assets/js/184.d853e461.js"><link rel="prefetch" href="/assets/js/185.b0233d58.js"><link rel="prefetch" href="/assets/js/186.46563f8c.js"><link rel="prefetch" href="/assets/js/187.8f099752.js"><link rel="prefetch" href="/assets/js/188.3d2adfff.js"><link rel="prefetch" href="/assets/js/189.56085996.js"><link rel="prefetch" href="/assets/js/19.29243772.js"><link rel="prefetch" href="/assets/js/190.74ee9249.js"><link rel="prefetch" href="/assets/js/191.2912c7b3.js"><link rel="prefetch" href="/assets/js/192.816999ff.js"><link rel="prefetch" href="/assets/js/193.66e79d51.js"><link rel="prefetch" href="/assets/js/194.a0aef591.js"><link rel="prefetch" href="/assets/js/195.ca729864.js"><link rel="prefetch" href="/assets/js/196.5f2550df.js"><link rel="prefetch" href="/assets/js/197.53a5a951.js"><link rel="prefetch" href="/assets/js/198.9b7fd80a.js"><link rel="prefetch" href="/assets/js/199.7d76d45a.js"><link rel="prefetch" href="/assets/js/20.65ee3cb2.js"><link rel="prefetch" href="/assets/js/200.beed8c2d.js"><link rel="prefetch" href="/assets/js/201.60704fe0.js"><link rel="prefetch" href="/assets/js/202.0f40a335.js"><link rel="prefetch" href="/assets/js/203.c4a08479.js"><link rel="prefetch" href="/assets/js/204.f281776c.js"><link rel="prefetch" href="/assets/js/205.486b8447.js"><link rel="prefetch" href="/assets/js/206.b9d6473d.js"><link rel="prefetch" href="/assets/js/207.0100e25c.js"><link rel="prefetch" href="/assets/js/208.1f4aeb54.js"><link rel="prefetch" href="/assets/js/209.421e2a33.js"><link rel="prefetch" href="/assets/js/21.f02a2061.js"><link rel="prefetch" href="/assets/js/210.1c1f9f92.js"><link rel="prefetch" href="/assets/js/211.033ec43d.js"><link rel="prefetch" href="/assets/js/212.eaedd29f.js"><link rel="prefetch" href="/assets/js/213.8fa26e5f.js"><link rel="prefetch" href="/assets/js/214.b09ab61f.js"><link rel="prefetch" href="/assets/js/215.ba27a46e.js"><link rel="prefetch" href="/assets/js/216.3d36839f.js"><link rel="prefetch" href="/assets/js/217.c408db8c.js"><link rel="prefetch" href="/assets/js/218.8d420404.js"><link rel="prefetch" href="/assets/js/219.024c3aff.js"><link rel="prefetch" href="/assets/js/22.77807269.js"><link rel="prefetch" href="/assets/js/220.5cd1fed8.js"><link rel="prefetch" href="/assets/js/221.c8398355.js"><link rel="prefetch" href="/assets/js/222.eee93b67.js"><link rel="prefetch" href="/assets/js/223.890a46b1.js"><link rel="prefetch" href="/assets/js/224.af9ae0f2.js"><link rel="prefetch" href="/assets/js/225.64543242.js"><link rel="prefetch" href="/assets/js/226.67eb4e8b.js"><link rel="prefetch" href="/assets/js/227.9dea1e95.js"><link rel="prefetch" href="/assets/js/228.9fd3cd8c.js"><link rel="prefetch" href="/assets/js/229.e3bb4f30.js"><link rel="prefetch" href="/assets/js/23.04033c47.js"><link rel="prefetch" href="/assets/js/230.fd5e90a4.js"><link rel="prefetch" href="/assets/js/231.77d39633.js"><link rel="prefetch" href="/assets/js/232.0fb9b697.js"><link rel="prefetch" href="/assets/js/233.9fd67d1e.js"><link rel="prefetch" href="/assets/js/234.df71f2f9.js"><link rel="prefetch" href="/assets/js/235.72c89c6a.js"><link rel="prefetch" href="/assets/js/236.71d9c1f7.js"><link rel="prefetch" href="/assets/js/237.291e0d2b.js"><link rel="prefetch" href="/assets/js/238.39113381.js"><link rel="prefetch" href="/assets/js/239.468bdffb.js"><link rel="prefetch" href="/assets/js/24.d5ebdf50.js"><link rel="prefetch" href="/assets/js/240.6a6ca3de.js"><link rel="prefetch" href="/assets/js/241.f9a26874.js"><link rel="prefetch" href="/assets/js/242.9d8553eb.js"><link rel="prefetch" href="/assets/js/25.56b8443d.js"><link rel="prefetch" href="/assets/js/26.c90580d1.js"><link rel="prefetch" href="/assets/js/27.ec93c7fa.js"><link rel="prefetch" href="/assets/js/28.38543972.js"><link rel="prefetch" href="/assets/js/29.2d9ac121.js"><link rel="prefetch" href="/assets/js/3.9c9ba874.js"><link rel="prefetch" href="/assets/js/30.566c00ec.js"><link rel="prefetch" href="/assets/js/31.840c7368.js"><link rel="prefetch" href="/assets/js/32.085a9b53.js"><link rel="prefetch" href="/assets/js/33.2568f008.js"><link rel="prefetch" href="/assets/js/34.c693b23c.js"><link rel="prefetch" href="/assets/js/35.0b12ec66.js"><link rel="prefetch" href="/assets/js/36.5de34291.js"><link rel="prefetch" href="/assets/js/37.316e55e2.js"><link rel="prefetch" href="/assets/js/38.fedb1c7b.js"><link rel="prefetch" href="/assets/js/39.3903f3e4.js"><link rel="prefetch" href="/assets/js/4.e2e10cba.js"><link rel="prefetch" href="/assets/js/40.b458a04d.js"><link rel="prefetch" href="/assets/js/41.51efbc84.js"><link rel="prefetch" href="/assets/js/42.5c079c5c.js"><link rel="prefetch" href="/assets/js/43.d67826ec.js"><link rel="prefetch" href="/assets/js/44.e4379bb2.js"><link rel="prefetch" href="/assets/js/45.d1573aa8.js"><link rel="prefetch" href="/assets/js/46.9ed06d3b.js"><link rel="prefetch" href="/assets/js/47.44c98776.js"><link rel="prefetch" href="/assets/js/48.8bcc4819.js"><link rel="prefetch" href="/assets/js/49.ad20e965.js"><link rel="prefetch" href="/assets/js/5.9862dc9a.js"><link rel="prefetch" href="/assets/js/50.e8fde2ac.js"><link rel="prefetch" href="/assets/js/51.73d7229f.js"><link rel="prefetch" href="/assets/js/52.250dc5fe.js"><link rel="prefetch" href="/assets/js/53.f604ad65.js"><link rel="prefetch" href="/assets/js/54.1c7de7b1.js"><link rel="prefetch" href="/assets/js/55.4d268d71.js"><link rel="prefetch" href="/assets/js/56.9da1ef8f.js"><link rel="prefetch" href="/assets/js/57.5a47f404.js"><link rel="prefetch" href="/assets/js/58.f02f1dd9.js"><link rel="prefetch" href="/assets/js/59.866dce11.js"><link rel="prefetch" href="/assets/js/6.ab1c77d5.js"><link rel="prefetch" href="/assets/js/60.b747b975.js"><link rel="prefetch" href="/assets/js/61.dbd99295.js"><link rel="prefetch" href="/assets/js/62.64069c98.js"><link rel="prefetch" href="/assets/js/63.ed8b0dd0.js"><link rel="prefetch" href="/assets/js/64.3acd796b.js"><link rel="prefetch" href="/assets/js/65.b9dbfb42.js"><link rel="prefetch" href="/assets/js/66.61b81117.js"><link rel="prefetch" href="/assets/js/67.8d82f096.js"><link rel="prefetch" href="/assets/js/68.e3a8f010.js"><link rel="prefetch" href="/assets/js/69.4f199ada.js"><link rel="prefetch" href="/assets/js/7.32aa26cb.js"><link rel="prefetch" href="/assets/js/70.5b5eccfe.js"><link rel="prefetch" href="/assets/js/71.a19b24f5.js"><link rel="prefetch" href="/assets/js/72.01636d1f.js"><link rel="prefetch" href="/assets/js/73.4ea8ca9c.js"><link rel="prefetch" href="/assets/js/74.624abc0f.js"><link rel="prefetch" href="/assets/js/75.7e0202b6.js"><link rel="prefetch" href="/assets/js/76.7aaabc49.js"><link rel="prefetch" href="/assets/js/77.90e5533f.js"><link rel="prefetch" href="/assets/js/78.3758ee0d.js"><link rel="prefetch" href="/assets/js/79.15d46be1.js"><link rel="prefetch" href="/assets/js/8.cdadef6d.js"><link rel="prefetch" href="/assets/js/80.952bd008.js"><link rel="prefetch" href="/assets/js/81.3f570b43.js"><link rel="prefetch" href="/assets/js/82.62e50e74.js"><link rel="prefetch" href="/assets/js/83.3bf5ea27.js"><link rel="prefetch" href="/assets/js/84.e89c9df3.js"><link rel="prefetch" href="/assets/js/85.b9ec2ec1.js"><link rel="prefetch" href="/assets/js/86.cf032aea.js"><link rel="prefetch" href="/assets/js/87.5b38d42a.js"><link rel="prefetch" href="/assets/js/88.95904b6f.js"><link rel="prefetch" href="/assets/js/89.700238a1.js"><link rel="prefetch" href="/assets/js/9.b8b9f88e.js"><link rel="prefetch" href="/assets/js/90.3371b61c.js"><link rel="prefetch" href="/assets/js/91.5ac22d50.js"><link rel="prefetch" href="/assets/js/92.5edf548a.js"><link rel="prefetch" href="/assets/js/93.7c2caa65.js"><link rel="prefetch" href="/assets/js/94.af97350f.js"><link rel="prefetch" href="/assets/js/95.977e351c.js"><link rel="prefetch" href="/assets/js/96.783365c1.js"><link rel="prefetch" href="/assets/js/97.1c56ba20.js"><link rel="prefetch" href="/assets/js/98.8bec8d2e.js"><link rel="prefetch" href="/assets/js/99.30c76886.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.102ccaf5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76f153c4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="前端知识" class="logo"> <span class="site-name can-hide">前端知识</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/doc/es6/" class="nav-link">ES6</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/js/" class="nav-link">js</a></li><li class="dropdown-item"><!----> <a href="/doc/js/standardLibrary/" class="nav-link">js标准库</a></li><li class="dropdown-item"><!----> <a href="/doc/dom/" class="nav-link">dom操作文档</a></li><li class="dropdown-item"><!----> <a href="/doc/designPattern/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/doc/browserNetwork/" class="nav-link">浏览器</a></div><div class="nav-item"><a href="/doc/css/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/doc/react/" class="nav-link router-link-active">react</a></div><div class="nav-item"><a href="/doc/vue/" class="nav-link">vue</a></div><div class="nav-item"><a href="/doc/typeScript/" class="nav-link">TypeScript</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/html/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/doc/node/" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/doc/tool/" class="nav-link">工具</a></li><li class="dropdown-item"><!----> <a href="/doc/tool/echarts/" class="nav-link">echarts</a></li><li class="dropdown-item"><!----> <a href="/doc/problem/" class="nav-link">常见问题</a></li></ul></div></div> <a href="https://github.com/yulilong/front-end-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/doc/es6/" class="nav-link">ES6</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/js/" class="nav-link">js</a></li><li class="dropdown-item"><!----> <a href="/doc/js/standardLibrary/" class="nav-link">js标准库</a></li><li class="dropdown-item"><!----> <a href="/doc/dom/" class="nav-link">dom操作文档</a></li><li class="dropdown-item"><!----> <a href="/doc/designPattern/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/doc/browserNetwork/" class="nav-link">浏览器</a></div><div class="nav-item"><a href="/doc/css/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/doc/react/" class="nav-link router-link-active">react</a></div><div class="nav-item"><a href="/doc/vue/" class="nav-link">vue</a></div><div class="nav-item"><a href="/doc/typeScript/" class="nav-link">TypeScript</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/html/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/doc/node/" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/doc/tool/" class="nav-link">工具</a></li><li class="dropdown-item"><!----> <a href="/doc/tool/echarts/" class="nav-link">echarts</a></li><li class="dropdown-item"><!----> <a href="/doc/problem/" class="nav-link">常见问题</a></li></ul></div></div> <a href="https://github.com/yulilong/front-end-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/doc/react/" class="sidebar-link">react文档</a></li><li><a href="/doc/react/001-react编程规范.html" class="sidebar-link">react编程规范</a></li><li><a href="/doc/react/002-react使用手册.html" class="sidebar-link">react使用手册</a></li><li><a href="/doc/react/003-react代码片段.html" class="sidebar-link">react代码片段</a></li><li><a href="/doc/react/004-react高阶组件.html" class="sidebar-link">高阶组件</a></li><li><a href="/doc/react/005-react开发遇到的问题.html" class="sidebar-link">react开发遇到的问题</a></li><li><a href="/doc/react/005-react中eslint代码检查常见问题解决.html" class="sidebar-link">react中eslint代码检查常见问题解决</a></li><li><a href="/doc/react/006-react平时注意的规范.html" class="sidebar-link">react 平时注意的规范</a></li><li><a href="/doc/react/007-react生命周期.html" class="sidebar-link">react组件生命周期</a></li><li><a href="/doc/react/008-react类型检查PropTypes.html" class="sidebar-link">react类型检查PropTypes</a></li><li><a href="/doc/react/009-react-Hook.html" class="sidebar-link">react Hook</a></li><li><a href="/doc/react/009-hooks.html" class="one-level one-level-active active sidebar-link">React Hooks详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_1-概述" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_2-hooks数据驱动更新" class="sidebar-link">2. hooks数据驱动更新</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_3-执行副作用" class="sidebar-link">3. 执行副作用</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_4-状态获取与传递" class="sidebar-link">4. 状态获取与传递</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_5-状态派生与保存" class="sidebar-link">5. 状态派生与保存</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_6-工具-hooks" class="sidebar-link">6. 工具 hooks</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_7-函数组件使用注意事项" class="sidebar-link">7. 函数组件使用注意事项</a></li><li class="sidebar-sub-header"><a href="/doc/react/009-hooks.html#_8-hooks-使用规则" class="sidebar-link">8. hooks 使用规则</a></li></ul></li><li><a href="/doc/react/010-diff算法和性能优化.html" class="sidebar-link">react diff 算法和性能优化</a></li><li><a href="/doc/react/011-react-Virtual-Dom.html" class="sidebar-link">react Virtual DOM</a></li><li><a href="/doc/react/012-react-fiber.html" class="sidebar-link">react Fiber介绍</a></li><li><a href="/doc/react/013-react-dnd拖动组件.html" class="sidebar-link">react-dnd组件使用教程</a></li><li><a href="/doc/react/014-react-refs引用dom.html" class="sidebar-link">refs引用dom</a></li><li><a href="/doc/react/015-react的setState说明.html" class="sidebar-link">react中setState说明</a></li><li><a href="/doc/react/016-react中使用echarts.html" class="sidebar-link">react中使用echarts</a></li><li><a href="/doc/react/017-render-props.html" class="sidebar-link">Render Props</a></li><li><a href="/doc/react/018-react父子组件执行顺序.html" class="sidebar-link">react父子组件交互生命周期执行顺序</a></li><li><a href="/doc/react/019-react类组件和函数组件区别.html" class="sidebar-link">react类组件和函数组件区别</a></li></ul> </div> <div class="page"> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#_1-概述">1. 概述</a></li><li><a href="#_2-hooks数据驱动更新">2. hooks数据驱动更新</a><ul><li><a href="#_2-1-usestate">2.1 useState</a></li><li><a href="#_2-2-usereducer">2.2 useReducer</a></li><li><a href="#_2-3-usesyncexternalstore-v18新增">2.3 useSyncExternalStore(v18新增)</a></li><li><a href="#_2-4-usetransition-v18新增">2.4 useTransition(v18新增)</a></li><li><a href="#_2-5-usedeferredvalue-v18新增">2.5 useDeferredValue(v18新增)</a></li></ul></li><li><a href="#_3-执行副作用">3. 执行副作用</a><ul><li><a href="#_3-1-三个方法的区别">3.1 三个方法的区别</a></li><li><a href="#_3-1-useeffect">3.1 useEffect</a></li><li><a href="#_3-2-uselayouteffect">3.2 useLayoutEffect</a></li><li><a href="#_3-3-useinsertioneffect">3.3 useInsertionEffect</a></li></ul></li><li><a href="#_4-状态获取与传递">4. 状态获取与传递</a><ul><li><a href="#_4-1-usecontext">4.1 useContext</a></li><li><a href="#_4-2-useref">4.2 useRef</a></li><li><a href="#_4-3-useimperativehandle">4.3 useImperativeHandle</a></li></ul></li><li><a href="#_5-状态派生与保存">5. 状态派生与保存</a><ul><li><a href="#_5-1-usememo">5.1 useMemo</a></li><li><a href="#_5-2-usecallback">5.2 useCallback</a></li></ul></li><li><a href="#_6-工具-hooks">6. 工具 hooks</a><ul><li><a href="#_6-1-usedebugvalue">6.1 useDebugValue</a></li><li><a href="#_6-2-useid">6.2 useId</a></li><li><a href="#_6-2-1-v18-ssr">6.2.1 v18 ssr</a></li></ul></li><li><a href="#_7-函数组件使用注意事项">7. 函数组件使用注意事项</a><ul><li><a href="#_7-1-关于严格模式hooks的影响">7.1 关于严格模式hooks的影响</a></li></ul></li><li><a href="#_8-hooks-使用规则">8. hooks 使用规则</a><ul><li><a href="#_1、只在最顶层使用-hook。不要在循环，条件或嵌套函数中调用-hook">1、只在最顶层使用 Hook。不要在循环，条件或嵌套函数中调用 Hook</a></li><li><a href="#_2、只在-react-函数中调用-hook。不要在普通的-javascript-函数中调用-hook。你可以：">2、只在 React 函数中调用 Hook。不要在普通的 JavaScript 函数中调用 Hook。你可以：</a></li><li><a href="#_8-1-为什么不能在循环、条件或嵌套函数中调用hooks">8.1 为什么不能在循环、条件或嵌套函数中调用Hooks</a></li><li><a href="#_8-2-为什么只能在函数组件中调用-hooks-？">8.2 为什么只能在函数组件中调用 hooks ？</a></li></ul></li></ul></div><p></p> <p>[TOC]</p> <h1 id="react-hooks详解"><a href="#react-hooks详解" aria-hidden="true" class="header-anchor">#</a> React Hooks详解</h1> <h2 id="_1-概述"><a href="#_1-概述" aria-hidden="true" class="header-anchor">#</a> 1. 概述</h2> <p><strong>Hooks</strong> 是 React 16.8 的新增特性。并在React 18版本新增了一些功能。Hooks可以让函数组件也可以实现部分类组件的功能，比如state状态管理、部分React生命周期钩子、以及其他的React特性。</p> <p>在Hooks出现以前，开发遇到的问题：</p> <ul><li>函数组件后期维护需要添加状态管理的功能</li> <li>一些函数组件中不能处理接口请求、获取数据的逻辑处理，只能改成类组件</li> <li>类组件随着开发功能越来越多，随着功能增强而变得越来越臃肿。在进行优化拆分时，只要有状态管理的就都需要使用类组件拆分</li></ul> <p>所以 Hooks 出现本质上原因是：</p> <ul><li><strong>让函数组件也能做类组件的事，有自己的状态，可以处理一些副作用，能获取 ref ，也能做数据缓存</strong></li> <li><strong>解决逻辑复用难的问题</strong></li> <li><strong>放弃面向对象编程，拥抱函数式编程</strong></li></ul> <p>关于自定义  Hooks：</p> <p>自定义 hooks 是在 React Hooks 基础上的一个拓展，可以根据业务需求制定满足业务需要的组合 hooks ，更注重的是逻辑单元。通过业务场景不同，到底需要React Hooks 做什么，怎么样把一段逻辑封装起来，做到复用，这是自定义 hooks 产生的初衷。</p> <p>自定义 hooks 也可以说是 React Hooks 聚合产物，其内部有一个或者多个 React Hooks 组成，用于解决一些复杂逻辑。</p> <p>hooks功能概览和出现的版本：</p> <p><img src="/assets/img/023-hooks.c9f2c4fc.png" alt></p> <h2 id="_2-hooks数据驱动更新"><a href="#_2-hooks数据驱动更新" aria-hidden="true" class="header-anchor">#</a> 2. hooks数据驱动更新</h2> <h3 id="_2-1-usestate"><a href="#_2-1-usestate" aria-hidden="true" class="header-anchor">#</a> 2.1 useState</h3> <p>useState 可以使函数组件像类组件一样拥有 state，函数组件通过 useState 可以让组件重新渲染，更新视图。</p> <p>使用方法、参数说明：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span> state <span class="token punctuation">,</span> setState <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initData<span class="token punctuation">)</span>
</code></pre></div><ul><li>state：状态变量，目的提供给 UI ，作为渲染视图的数据源。</li> <li>setState：用于更新状态值的函数。当使用这个函数设置新的状态时，React 会根据新的状态重新渲染组件。</li> <li>initData：状态的初始值。分为三种情况：第一种是不传，则 state 的初始值为undefined。第二种情况是非函数，将作为 state 初始化的值。 第三种情况是函数，函数的返回值作为 useState 初始化的值。</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> <span class="token function-variable function">DemoState</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">/* number为此时state读取值 ，setNumber为派发更新的函数 */</span>
   <span class="token keyword">let</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">/* 0为初始值 */</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> number <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">setNumber</span><span class="token punctuation">(</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 会在下次渲染才更新number便令</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token comment">/* 这里的number是 旧值 */</span>
       <span class="token punctuation">}</span> <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>useState 注意事项：</strong></p> <p>1、在函数组件一次执行上下文中，state 的值是固定不变的</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> number<span class="token punctuation">,</span> setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// // 此时 number 一直都是 0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> handleClick <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text"> 点击 </span><span class="token punctuation">{</span> number <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、 如果两次传入相同的 state 值，那么组件就不会更新</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">let</span> account <span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> state  <span class="token punctuation">,</span> dispatchState <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span><span class="token string">'alien'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span>  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// 点击按钮，视图没有更新。</span>
    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Alien'</span><span class="token punctuation">;</span>
    <span class="token function">dispatchState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token comment">// state变量是对象，存储的是对象地址，这么操作直接等于内存地址重新赋值了相同的值。而传入相同的state值，组件不会渲染，所以视图没有更新。但是对象内的属性已经修改成功了</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">changeName++</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、当执行<code>setState</code>时，在当前执行上下文中获取不到最新的 state, 只有再下一次组件 rerender 中才能获取到。</p> <p>4、当执行<code>setState</code>设置state值时，React 将跳过子组件的渲染及 effect 的执行。需要注意的是，React 可能仍需要在跳过渲染前渲染该组件。不过由于 React 不会对组件树的“深层”节点进行不必要的渲染，所以大可不必担心。如果你在渲染期间执行了高开销的计算，则可以使用 <code>useMemo</code> 来进行优化。</p> <p>官方文档：https://zh-hans.react.dev/reference/react/useState</p> <h3 id="_2-2-usereducer"><a href="#_2-2-usereducer" aria-hidden="true" class="header-anchor">#</a> 2.2 useReducer</h3> <p>useReducer 是 react-hooks 提供的能够在无状态组件中运行的类似redux的功能 api 。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span> ①state <span class="token punctuation">,</span> ②dispatch <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>③reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">,</span> processInitState<span class="token punctuation">)</span>
</code></pre></div><ul><li>state：状态变量，目的提供给 UI ，作为渲染视图的数据源。</li> <li>dispatch：用于更新状态值的函数。本质上跟 useState方法返回的 setState 方法一样。</li> <li>reducer：一个函数 reducer ，我们可以认为它就是一个 redux 中的 reducer , reducer的参数就是常规reducer里面的state和action, 返回改变后的state, 这里有一个需要注意的点就是：<strong>如果返回的 state 和之前的 state ，内存指向相同，那么组件将不会更新。</strong></li> <li>initialState：状态的初始值。如果不传则 state 的初始值为undefined。注意不能使用函数返回值形式设置。</li> <li>processInitState：选填，处理初始值的方法，initialState 可以当这个函数的参数使用。</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> State <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'reset'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">666</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子 重置 </span><span class="token punctuation">{</span>State<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">DemoUseReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>size<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* number为更新后的state值,  dispatchNumber 为当前的派发函数 */</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> dispatchNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> payload<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// /* return的值为新的state */</span>
      <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'sub'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'reset'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> payload<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>initialState <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">return</span> initialState <span class="token operator">*</span> size<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      当前值：</span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatchNumber</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'add'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">增加</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatchNumber</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'sub'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">减少</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* 把dispatch 和 state 传递给子组件  */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Index</span> <span class="token attr-name">dispatch</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>dispatchNumber<span class="token punctuation">}</span></span> <span class="token attr-name">State</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> number <span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> DemoUseReducer<span class="token punctuation">;</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useReducer</p> <h3 id="_2-3-usesyncexternalstore-v18新增"><a href="#_2-3-usesyncexternalstore-v18新增" aria-hidden="true" class="header-anchor">#</a> 2.3 useSyncExternalStore(v18新增)</h3> <p>useSyncExternalStore 的诞生和 v18 的更新模式下外部数据的 tearing 有着十分紧密的关联。useSyncExternalStore 能够让 React 组件在 concurrent 模式下安全地有效地读取外接数据源，在组件渲染过程中能够检测到变化，并且在数据源发生变化的时候，能够调度更新。当读取到外部状态发生了变化，会触发一个强制更新，来保证结果的一致性。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span> subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token punctuation">)</span>
</code></pre></div><ul><li>subscribe：为订阅函数，当数据改变的时候，会触发 subscribe，在 useSyncExternalStore 会通过带有记忆性的 getSnapshot 来判别数据是否发生变化，如果发生变化，那么会强制更新数据。</li> <li>getSnapshot：可以理解成一个带有记忆功能的选择器。当 store 变化的时候，会通过 getSnapshot 生成新的状态值，这个状态值可提供给组件作为数据源使用，getSnapshot 可以检查订阅的值是否改变，改变的话那么会触发更新。</li> <li>getServerSnapshot：用于 hydration 模式下的 getSnapshot。</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> combineReducers <span class="token punctuation">,</span> createStore  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>

<span class="token comment">/* number Reducer */</span>
<span class="token keyword">function</span> <span class="token function">numberReducer</span><span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'ADD'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token keyword">case</span> <span class="token string">'DEL'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> state
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 注册reducer */</span>
<span class="token keyword">const</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span>numberReducer  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 创建 store */</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span><span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 订阅外部数据源 */</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>subscribe<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>number<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span><span class="token string">'ADD'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>点击按钮，会触发 reducer ，然后会触发 store.subscribe 订阅函数，执行 getSnapshot 得到新的 number ，判断 number 是否发生变化，如果变化，触发更新。</p> <p>官方文档：https://zh-hans.react.dev/reference/react/useSyncExternalStore</p> <h3 id="_2-4-usetransition-v18新增"><a href="#_2-4-usetransition-v18新增" aria-hidden="true" class="header-anchor">#</a> 2.4 useTransition(v18新增)</h3> <p>在 React v18 中，有一种<code>并发模式(concurrent)</code>，<code>concurrent</code>模式允许将UI更新标记为高优先级的或者可中断的低优先级操作。而<code>useTransition()</code>方法可以将某些更新标记为<code>可中断的</code>和<code>非紧急的</code>-也就是所谓的<code>transitions</code>。这种新特性在大量的UI更新操作中尤其有效，比如过滤一个较大的列表。打个比方如下图当点击 tab 从 tab1 切换到 tab2 的时候，本质上产生了两个更新任务。</p> <ul><li>第一个就是 hover 状态由 tab1 变成 tab2。</li> <li>第二个就是内容区域由 tab1 内容变换到 tab2 内容。</li></ul> <p>这两个任务，用户肯定希望 hover 状态的响应更迅速，而内容的响应有可能还需要请求数据等操作，所以更新状态并不是立马生效，通常还会有一些 loading 效果。所以第一个任务作为<strong>立即执行任务</strong>，而第二个任务就可以视为<strong>过渡任务</strong>。</p> <p><img src="/assets/img/024-hooks.3e76f8e7.png" alt></p> <p>useTransition使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useTransition <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span> 
<span class="token keyword">const</span>  <span class="token punctuation">[</span> isPending <span class="token punctuation">,</span> startTransition <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>isPending：Boolean值，表示处于过渡状态的标志，指明这个<code>transition</code>正在加载中(<code>pending</code>)</li> <li>startTransition：设置过度的方法，这个方法接收一个函数作为参数，在这个参数函数里面执行一些地任务行为</li></ul> <p>useTransition 例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">/* 模拟数据 */</span>
<span class="token keyword">const</span> mockList1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'tab1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">+</span><span class="token string">'--'</span><span class="token operator">+</span>index <span class="token punctuation">)</span>
<span class="token keyword">const</span> mockList2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'tab2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">+</span><span class="token string">'--'</span><span class="token operator">+</span>index <span class="token punctuation">)</span>
<span class="token keyword">const</span> mockList3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'tab3'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">+</span><span class="token string">'--'</span><span class="token operator">+</span>index <span class="token punctuation">)</span>

<span class="token keyword">const</span> tab <span class="token operator">=</span> <span class="token punctuation">{</span> tab1<span class="token punctuation">:</span> mockList1<span class="token punctuation">,</span> tab2<span class="token punctuation">:</span> mockList2<span class="token punctuation">,</span> tab3<span class="token punctuation">:</span> mockList3 <span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> active<span class="token punctuation">,</span> setActive <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'tab1'</span><span class="token punctuation">)</span> <span class="token comment">//需要立即响应的任务，立即更新任务</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> renderData<span class="token punctuation">,</span> setRenderData <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span>active<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//不需要立即响应的任务，过渡任务</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> isPending<span class="token punctuation">,</span>startTransition  <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token keyword">const</span> <span class="token function-variable function">handleChangeTab</span> <span class="token operator">=</span> <span class="token punctuation">(</span>activeItem<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token function">setActive</span><span class="token punctuation">(</span>activeItem<span class="token punctuation">)</span> <span class="token comment">// 立即更新</span>
     <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">// startTransition 里面的任务优先级低</span>
       <span class="token function">setRenderData</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span>activeItem<span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>tab<span class="token punctuation">'</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token punctuation">{</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>tab<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> active <span class="token operator">===</span> item <span class="token operator">&amp;&amp;</span> <span class="token string">'active'</span> <span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">handleChangeTab</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>content<span class="token punctuation">'</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token punctuation">{</span> isPending <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> loading... </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">}</span><span class="token plain-text">
       </span><span class="token punctuation">{</span> renderData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useTransition</p> <h3 id="_2-5-usedeferredvalue-v18新增"><a href="#_2-5-usedeferredvalue-v18新增" aria-hidden="true" class="header-anchor">#</a> 2.5 useDeferredValue(v18新增)</h3> <p>useDeferredValue用来接受一个值，并返回该值的新副本，该副本将推迟到更紧急地更新之后。由于React 18 将UI更新标记为高优先级的或者可中断的低优先级操作。所以我们可以在高优先级任务结束后，再得到新的状态，而这个新的状态就称之为 DeferredValue。</p> <p>useDeferredValue使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useDeferredValue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> deferrredValue <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useDeferredValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> initialValue<span class="token operator">?</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>value：你想延迟的值，可以是任何类型。</li> <li>initialValue：可选值，组件初始渲染时使用的值。如果省略此选项，<code>useDeferredValue</code> 在初始渲染期间不会延迟，因为没有以前的版本可以渲染。</li> <li>deferrredValue：延迟的值</li></ul> <p>注意事项：</p> <ul><li>当更新发生在 Transition 内部时，<code>useDeferredValue</code> 总是返回新的 <code>value</code> 并且不会产生延迟渲染，因为该更新已经被延迟了。</li> <li>传递给 <code>useDeferredValue</code> 的值应该是原始值（如字符串和数字）或是在渲染之外创建的对象。如果你在渲染期间创建一个新对象并立即将其传递给 <code>useDeferredValue</code>，它在每次渲染时都会不同，从而导致不必要的后台重新渲染。</li> <li><code>useDeferredValue</code> 本身不会引起任何固定的延迟。一旦 React 完成原始的重新渲染，它会立即开始使用新的延迟值处理后台重新渲染。由事件（例如输入）引起的任何更新都会中断后台重新渲染，并被优先处理。</li> <li>由 <code>useDeferredValue</code> 引起的后台重新渲染在提交到屏幕之前不会触发 Effect。如果后台重新渲染被暂停，Effect 将在数据加载后和 UI 更新后运行。</li></ul> <p>用法：</p> <ul><li>1、在新内容加载期间显示旧内容</li> <li>2、延迟渲染 UI 的某些部分</li></ul> <p>useDeferredValue 例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>
<span class="token keyword">const</span> tab <span class="token operator">=</span> <span class="token punctuation">{</span> tab1<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tab2<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tab3<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> active<span class="token punctuation">,</span> setActive <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'tab1'</span><span class="token punctuation">)</span> <span class="token comment">//需要立即响应的任务，立即更新任务</span>
  <span class="token keyword">const</span> deferActive <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useDeferredValue</span><span class="token punctuation">(</span>active<span class="token punctuation">)</span> <span class="token comment">// 把状态延时更新，类似于过渡任务</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleChangeTab</span> <span class="token operator">=</span> <span class="token punctuation">(</span>activeItem<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token function">setActive</span><span class="token punctuation">(</span>activeItem<span class="token punctuation">)</span> <span class="token comment">// 立即更新</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> renderData <span class="token operator">=</span> tab<span class="token punctuation">[</span>deferActive<span class="token punctuation">]</span> <span class="token comment">// 使用滞后状态</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>tab<span class="token punctuation">'</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token punctuation">{</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>tab<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> active <span class="token operator">===</span> item <span class="token operator">&amp;&amp;</span> <span class="token string">'active'</span> <span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">handleChangeTab</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>content<span class="token punctuation">'</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token punctuation">{</span> renderData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// 如上 active 为正常改变的状态，deferActive 为滞后的 active 状态，我们使用正常状态去改变 tab 的 active 状态，使用滞后的状态去更新视图，同样达到了提升用户体验的作用。</span>
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> memo<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> useDeferredValue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> SlowList <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">SlowList</span><span class="token punctuation">(</span><span class="token punctuation">{</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 仅打印一次。实际的减速是在 SlowItem 组件内部。</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[ARTIFICIALLY SLOW] Rendering 250 &lt;SlowItem /&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">250</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SlowItem</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span> <span class="token attr-name">text</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>items<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>items<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">SlowItem</span><span class="token punctuation">(</span><span class="token punctuation">{</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每个 item 暂停 1ms，模拟极其缓慢的代码</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Text: </span><span class="token punctuation">{</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> deferredText <span class="token operator">=</span> <span class="token function">useDeferredValue</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>e <span class="token operator">=&gt;</span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SlowList</span> <span class="token attr-name">text</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>deferredText<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在这个例子中，SlowList 组件中的每个 item 都被 故意减缓了渲染速度，这样你就可以看到 useDeferredValue 是如何让输入保持响应的。当你在输入框中输入时，你会发现输入很灵敏，而列表的更新会稍有延迟。</span>
<span class="token comment">// 例子链接：https://zh-hans.react.dev/reference/react/useDeferredValue#examples</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useDeferredValue</p> <h2 id="_3-执行副作用"><a href="#_3-执行副作用" aria-hidden="true" class="header-anchor">#</a> 3. 执行副作用</h2> <p>React hooks也提供了 api ，用于弥补函数组件没有生命周期的缺陷。其本质主要是运用了 hooks 里面的 useEffect、useLayoutEffect、useInsertionEffect。其中最常用的就是 useEffect 。</p> <p><strong>注意</strong>：<code>useInsertionEffect</code> 方法是react 18 版本才有的，低于这个版本没有这个方法。</p> <h3 id="_3-1-三个方法的区别"><a href="#_3-1-三个方法的区别" aria-hidden="true" class="header-anchor">#</a> 3.1 三个方法的区别</h3> <p>由于useEffect、useLayoutEffect、 useInsertionEffect三个方法的参数和用法都一样。他们唯一的区别就是执行的时机不一样。关于三个方法参数和用法下一小节会介绍。这里我们先着重介绍他们的区别。</p> <p>1、三个方法执行效果：<br>
1.1 执行顺序：useInsertionEffect 执行 -&gt; useLayoutEffect 执行 -&gt; useEffect 执行<br>
1.2 在方法中修改dom：都是在这一次更新中完成。<br>
1.2 在方法中修改状态变量：都触发了组件第二次更新。</p> <p>2、三个方法执行时机(区别)：<br>
2.1 useEffect：在组件渲染到屏幕之后异步执行。这意味着它不会阻塞浏览器的绘制和更新<br>
2.2 useLayoutEffect：在修改 DOM 之后，在浏览器进行布局和绘制之前同步执行。<br>
2.3 useInsertionEffect：在布局副作用触发之前将元素插入到 DOM 中，在useLayoutEffect之前执行</p> <p>3、三个方法在使用上说明：</p> <ul><li>useEffect
<ul><li>特点、使用场景：由于是异步执行，不会阻塞页面的渲染，对用户交互的响应性影响较小，适用于大多数与数据获取、订阅事件、手动修改<code>DOM</code>等不会直接影响页面布局和视觉呈现的操作。</li> <li>缺点：由于是在浏览器绘制视图之后执行，如果在这个方法里面去修改DOM元素，就可能会导致浏览器再次回流和重绘。而且由于两次绘制，视图上可能会造成闪现突兀的效果。</li></ul></li> <li>useLayoutEffect
<ul><li>特点、使用场景：解决 useEffect 修改 DOM 的问题。在这个方法里面可以获取更新后的 DOM，修改 DOM，修改后马上渲染到页面中。</li> <li>缺点：由于还在等待页面渲染呢，这个方法是同步执行的，如果在其中执行的操作耗时较长，会阻塞页面的渲染，可能导致页面卡顿，影响用户体验。尽可能使用 <code>useEffect</code>。</li></ul></li> <li>useInsertionEffect：是为 CSS-in-JS 库的作者特意打造的。除非你正在使用 CSS-in-JS 库并且需要注入样式，否则你应该使用 <code>useEffect</code> 或者 <code>useLayoutEffect</code>。</li></ul> <p>三个方法的执行测试例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> h <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 用来测试 三个副作用方法 的执行顺序，把flag变量值改成对应的值即可</span>
  <span class="token keyword">const</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(`${name}`);</span>
    <span class="token keyword">const</span> flag <span class="token operator">=</span> <span class="token string">'useInsertionEffect'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// h += 10; divRef.current.innerText = h;                // 1、修改dom</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">setCount</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 2、修改状态</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> divRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'useEffect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'useLayoutEffect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'useInsertionEffect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log('函数组件体,', count);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>divRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'函数组件体'</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> divRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hook-test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>divRef<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> border<span class="token punctuation">:</span> <span class="token string">'1px solid'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">This is</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">count: </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 1、修改dom：&lt;button onClick={e =&gt; setCount(count + 1)}&gt;count&lt;/button&gt; */</span><span class="token punctuation">}</span><span class="token plain-text">
    2、修改状态：</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>e <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Index<span class="token punctuation">;</span>
<span class="token comment">// 函数组件渲染步骤：</span>
<span class="token comment">// 1. 函数组件执行，返回了 经过处理逻辑的的dom</span>
<span class="token comment">// 2. useInsertionEffect 执行</span>
<span class="token comment">// 3. useLayoutEffect 执行</span>
<span class="token comment">// 4. 经过修改的dom渲染到浏览器中。</span>
<span class="token comment">// 5. useEffect 执行，这次渲染结束</span>
</code></pre></div><h3 id="_3-1-useeffect"><a href="#_3-1-useeffect" aria-hidden="true" class="header-anchor">#</a> 3.1 useEffect</h3> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>setup<span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 真正使用的时候是这种形式的</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行副作用操作</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 清理操作执行方法，可选</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖数组</span>
</code></pre></div><ul><li>setup：处理 Effect 的函数。setup 函数选择性返回一个 <strong>清理(cleanup)</strong> 函数，作为下一次setup执行前调用，用于清理上一次setup执行产生的副作用。</li> <li>dependencies：可选参数，类型是数组，作为执行setup处理函数的依赖项。当依赖项改变，会触发useEffect执行。React 将使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="noopener noreferrer"><code>Object.is</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来比较每个依赖项和它先前的值。这个参数分为三种情况：
<ul><li>传有值的数组([dep1, dep2])：当依赖项改变，会触发useEffect执行。</li> <li>传空数组([])：只在初始挂载后执行一次，相当于componentDidMount方法</li> <li>不传：每次重新渲染组件后都会运行 Effect 函数</li></ul></li></ul> <p><strong>React 在必要时会调用 setup 和 cleanup，这可能会发生多次</strong>：</p> <ul><li>1、初次挂载到页面后，运行 setup 代码</li> <li>2、每次重新渲染组件结束后(如果传了第二个参数，那么只有在依赖项值发生改变才执行)：
<ul><li>2.1 首先，使用旧的 props 和 state 运行**清理(cleanup)**函数。</li> <li>2.2 然后，使用新的 props 和 state 运行 setup 代码。</li></ul></li> <li>3、组件卸载之前，<strong>清理(cleanup)</strong> 函数 将运行最后一次。</li></ul> <p>一个使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>

<span class="token keyword">function</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 模拟数据交互</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span>a<span class="token punctuation">,</span> age<span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">Demo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> a <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span> userMessage <span class="token punctuation">,</span> setUserMessage <span class="token punctuation">]</span> <span class="token punctuation">:</span>any<span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> div<span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleResize</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">// 模拟事件监听处理函数</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token comment">// 请求数据</span>
     <span class="token function">getUserInfo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res<span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token function">setUserMessage</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
     window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> handleResize<span class="token punctuation">)</span> <span class="token comment">// 事件监听</span>
     <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 此函数用于清除副作用</span>
         <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span> 
         window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> handleResize<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
  <span class="token comment">// 只有当 a 和 number 改变的时候,useEffect 函数才会重新执行</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> a <span class="token punctuation">,</span>number <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 这里如果不加限制 ，会是函数重复执行，陷入死循环</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useEffect1111 只执行一次'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数组为空[],只在初始挂载后执行一次，相当于componentDidMount方法</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>div<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> userMessage<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> userMessage<span class="token punctuation">.</span>age <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> number <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useEffect</p> <h3 id="_3-2-uselayouteffect"><a href="#_3-2-uselayouteffect" aria-hidden="true" class="header-anchor">#</a> 3.2 useLayoutEffect</h3> <p>useLayoutEffect 使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> h <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    h <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span> divRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> h<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hook-test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>divRef<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> border<span class="token punctuation">:</span> <span class="token string">'1px solid'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">This is</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">count: </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    修改dom：</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>e <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Index<span class="token punctuation">;</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useLayoutEffect</p> <h3 id="_3-3-useinsertioneffect"><a href="#_3-3-useinsertioneffect" aria-hidden="true" class="header-anchor">#</a> 3.3 useInsertionEffect</h3> <p><code>useInsertionEffect</code> 是为 CSS-in-JS 库的作者特意打造的。除非你正在使用 CSS-in-JS 库并且需要注入样式，否则你应该使用 <a href="https://zh-hans.react.dev/reference/react/useEffect" target="_blank" rel="noopener noreferrer"><code>useEffect</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者 <a href="https://zh-hans.react.dev/reference/react/useLayoutEffect" target="_blank" rel="noopener noreferrer"><code>useLayoutEffect</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>useInsertionEffect 使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  React<span class="token punctuation">.</span><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">/* 动态创建 style 标签插入到 head 中 */</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
    style<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
       .css-in-js{
         color: red;
         font-size: 20px;
       }
     `</span></span>
    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>css-in-js<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text"> hello , useInsertionEffect </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useInsertionEffect</p> <h2 id="_4-状态获取与传递"><a href="#_4-状态获取与传递" aria-hidden="true" class="header-anchor">#</a> 4. 状态获取与传递</h2> <h3 id="_4-1-usecontext"><a href="#_4-1-usecontext" aria-hidden="true" class="header-anchor">#</a> 4.1 useContext</h3> <p>可以使用 useContext ，来获取父级组件传递过来的 context 值，这个当前值就是最近的父级组件 Provider 设置的 value 值，useContext 参数一般是由 createContext 方式创建的 ,也可以父级上下文 context 传递的 ( 参数为 context )。useContext 可以代替 context.Consumer 来获取 Provider 中保存的 value 值。</p> <p>useContext 接受一个参数，一般都是 context 对象，返回值为 context 对象内部保存的 value 值。</p> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// contextTest.js：定义一个context 文件，所有用到这个context的组件都要引用这个文件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> UserContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 共同的父组件发布变量</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@views/contextTest.js'</span><span class="token punctuation">;</span> <span class="token comment">// 引入共同的 Context</span>
<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让子组件可以修改 Context</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> age<span class="token punctuation">,</span> setAge<span class="token punctuation">:</span> setAge <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserInfo</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserContext.Provider</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 函数组件使用变量：1、通过useContext使用。</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@views/contextTest.js'</span><span class="token punctuation">;</span> <span class="token comment">// 引入共同的 Context</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>UserContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1、通过useContext获取变量</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">用户名: </span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">年龄: </span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>age<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">增加年龄</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useContext</p> <h3 id="_4-2-useref"><a href="#_4-2-useref" aria-hidden="true" class="header-anchor">#</a> 4.2 useRef</h3> <p>useRef 方法主要有下面两个作用：<br>
1、保存 DOM 引用：react内置了对它的支持。当把useRef变量传递给 JSX 中的 <code>ref</code> 属性时，react 会在创建DOM并渲染到页面后，把节点赋值给 ref 对象的 <code>current</code> 属性。<br>
2、保存状态：只要当前组件不被销毁，那么状态就会一直存在。改变 <code>ref.current</code> 属性时，React 不会重新渲染组件。React 不知道它何时会发生改变，因为 ref 是一个普通的 JavaScript 对象。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> ref <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>initialValue</code>：ref 对象的 <code>current</code> 属性的初始值。可以是任意类型的值。这个参数在首次渲染后被忽略。</li> <li>ref：返回一个只有一个属性的对象(ref.current)，current初始值为传递的 <code>initialValue</code>。之后可以将其设置为其他值。如果将 ref 对象作为一个 JSX 节点的 <code>ref</code> 属性传递给 React，React 将为它设置 <code>current</code> 属性。在后续的渲染中，<code>useRef</code> 将返回同一个对象。</li></ul> <p><strong>注意</strong>：<br>
1、除了 <a href="https://zh-hans.react.dev/reference/react/useRef#avoiding-recreating-the-ref-contents" target="_blank" rel="noopener noreferrer">初始化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 外不要在渲染期间写入或者读取 <code>ref.current</code>，否则会使组件行为变得不可预测。<br>
2、在严格模式下，React 将会 <strong>调用两次组件方法</strong>，这是为了 <a href="https://zh-hans.react.dev/reference/react/useState#my-initializer-or-updater-function-runs-twice" target="_blank" rel="noopener noreferrer">帮助发现意外问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。但这只是开发模式下的行为，不会影响生产模式。每个 ref 对象都将会创建两次，但是其中一个版本将被丢弃。如果使用的是组件纯函数（也应当如此），那么这不会影响其行为。<br>
3、<code>const ref = useRef()</code> 等同于 <code>const [ref, _] = useState(() =&gt; createRef(null))</code>。详情见：<a href="https://zh-hans.react.dev/reference/react/createRef" target="_blank" rel="noopener noreferrer">react.createRef<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，在实际代码中React.createRef() 跟 React.useRef() 效果一样。</p> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 保存变量，组件在变量在，修改不触发更新</span>
  <span class="token keyword">const</span> divRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存dom。</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useEffect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只执行了一次</span>
  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ref.current:'</span><span class="token punctuation">,</span> ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    text <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span> divRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token string">`dom修改</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>divRef<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">This is</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useRef</p> <h3 id="_4-3-useimperativehandle"><a href="#_4-3-useimperativehandle" aria-hidden="true" class="header-anchor">#</a> 4.3 useImperativeHandle</h3> <p>useImperativeHandle 可以让函数组件自定义实例对象用来给父组件调用。</p> <p>对于子组件，如果是 类组件，我们可以通过 ref 获取类组件的实例。但是在子组件是函数组件的情况下(函数组件没有ref属性)，则可以通过 forwardRef 方法来让函数组件拥有 ref 属性。</p> <p><strong>注意</strong>：由于react规定函数组件不能有ref属性(react19版本取消这个限制了)，函数组件也可以通过自定义的props属性达到 ref 的效果，详情见下面的例子。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> createHandle<span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>ref：从 <a href="https://zh-hans.react.dev/reference/react/forwardRef#render-function" target="_blank" rel="noopener noreferrer"><code>forwardRef</code> 渲染函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中获得的第二个参数。或者是props里面的自定义 ref 属性。父组件传过来的</li> <li>createHandle：处理函数，返回值作为暴露给父组件的 ref 对象。</li> <li>dependencies：可选参数，类型是数组，作为执行setup处理函数的依赖项。当依赖项改变，会执行createHandle生成新的 ref 对象。React 将使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="noopener noreferrer"><code>Object.is</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来比较每个依赖项和它先前的值。这个参数分为三种情况：
<ul><li>传有值的数组([dep1, dep2])：当依赖项改变，执行createHandle生成新的 ref 对象。</li> <li>传空数组([])：只在初始挂载后生成新的 ref 对象，相当于componentDidMount方法。这么做会导致一个问题，详情见下面的<strong>注意</strong>说明</li> <li>不传：每次重新渲染组件后都会执行createHandle生成新的 ref 对象</li></ul></li></ul> <p>useImperativeHandle使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token comment">// 父组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">Parent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ChildRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// React.useRef() 也一样</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> ChildRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">click</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ChildRef<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 子组件：和 forwardRef 方法配合 暴露自定义的 ref 对象给父组件</span>
<span class="token keyword">const</span> Child <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    func<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是子组件1，count：'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子组件</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 子组件：父组件使用&lt;Child onRef={ChildRef} /&gt; 这种自定义props属性来获取函数组件的自定义 ref 对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">Child</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>onRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    func<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是子组件，count：'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子组件</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong>：关于useImperativeHandle 方法依赖项传空数组产生的问题：<br>
createHandle 只会在组件挂载后执行一次，当父组件执行 ref 对象里面的方法时：读取子组件的state的值永远不会变(初始值)，调用子组件的setCount方法只有第一次有效，以后都是无效的。当为了性能优化而给依赖项传空数组的时候需要特别注意这一点。详情见如下例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> Child <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    func<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是子组件1，count：'</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子组件：</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 父组件执行 func 方法，console.log里面的count值永远是10， 页面count值只有在第一次点击后变成了11，后面的点击都没变化</span>
</code></pre></div><p>官方文档：https://zh-hans.react.dev/reference/react/useImperativeHandle</p> <h2 id="_5-状态派生与保存"><a href="#_5-状态派生与保存" aria-hidden="true" class="header-anchor">#</a> 5. 状态派生与保存</h2> <h3 id="_5-1-usememo"><a href="#_5-1-usememo" aria-hidden="true" class="header-anchor">#</a> 5.1 useMemo</h3> <p>useMemo 可以在函数组件 render 上下文中同步执行一个函数逻辑，这个函数的返回值可以作为一个新的状态缓存起来。<code>useMemo</code> 不会让首次渲染更快，它只会帮助你跳过不必要的更新工作。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> visible <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span>calculate<span class="token punctuation">,</span> deps<span class="token punctuation">)</span>
</code></pre></div><ul><li>calculate：计算缓存值的函数。这个函数没有参数，并且可以返回任意类型。React 将会在首次渲染时执行该函数返回结果；在之后的渲染中会根据 <code>deps</code> 参数情况而定。</li> <li>deps：类型是数组，作为执行 calculate 函数的依赖项。React 将使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="noopener noreferrer"><code>Object.is</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来比较每个依赖项和它先前的值。这个参数分为三种情况：
<ul><li>传有值的数组([dep1, dep2])：当依赖项改变，会触发 calculate 执行并返回结果。</li> <li>传空数组([])：只在初始挂载时执行一次，相当于componentDidMount方法。这个参数会导致 useMemo 再也不执行，也就获取不到后续更新了。失去了 useMemo 的意义</li> <li>不传：每次重新渲染组件时都会运行 useMemo 函数。这么做等于每次都重新计算结果，失去了 useMemo 的意义</li></ul></li> <li>visible：需要缓存的变量。calculate 函数执行后的返回值。</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> keeper <span class="token operator">=</span> <span class="token function">useKeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDispatch<span class="token punctuation">,</span> cacheList<span class="token punctuation">,</span> hasAliveStatus <span class="token punctuation">}</span> <span class="token operator">=</span> keeper
  <span class="token keyword">const</span> contextValue <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* 通过 useMemo 得到派生出来的新状态 contextValue  */</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      hasAliveStatus<span class="token punctuation">:</span> hasAliveStatus<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>keeper<span class="token punctuation">)</span><span class="token punctuation">,</span>
      cacheDestory<span class="token punctuation">:</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> cacheDispatch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>keeper<span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">ACTION_DESTORY</span><span class="token punctuation">,</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>keeper<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>KeepaliveContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>contextValue<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>KeepaliveContext.Provider</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要用到 useMemo 的地方：<br>
1、跳过代价昂贵的重新计算：默认情况下，React 会在每次重新渲染时重新运行整个组件。如果计算速度很快，这将不会产生问题。但是，当正在过滤转换一个大型数组，或者进行一些昂贵的计算，而数据没有改变，那么可能希望跳过这些重复计算。这种缓存行为叫做 <a href="https://en.wikipedia.org/wiki/Memoization" target="_blank" rel="noopener noreferrer">记忆化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<br>
2、跳过组件的重新渲染：<strong>默认情况下，当一个组件重新渲染时，React 会递归地重新渲染它的所有子组件</strong>。这对于不需要太多计算来重新渲染的组件来说很好。但是如果你已经确认重新渲染很慢，你可以通过将它包装在 <a href="https://zh-hans.react.dev/reference/react/memo" target="_blank" rel="noopener noreferrer"><code>memo</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，这样当它的 props 跟上一次渲染相同的时候它就会跳过本次渲染。<br>
3、防止过于频繁地触发 Effect：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">ChatRoom</span><span class="token punctuation">(</span><span class="token punctuation">{</span> roomId <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> serverUrl<span class="token punctuation">:</span> <span class="token string">'https://localhost:1234'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">:</span> roomId <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> connection<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1. 上面代码中，因为 Effect 中的每一个响应式值都应该声明为其依赖。 然而如果你将 options 声明为依赖，会导致在 Effect 在每次渲染后都会重新执行</span>
<span class="token comment">// 2. 为了解决这个场景，你可以使用 useMemo 将 Effect 中使用的对象包装起来</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> serverUrl<span class="token punctuation">:</span> <span class="token string">'https://localhost:1234'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">:</span> roomId <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>roomId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✅ 只有当 roomId 改变时才会被改变</span>
<span class="token comment">// 3. 然而，因为 useMemo 只是一个性能优化手段，而并不是语义上的保证，所以 React 在 特定场景下 会丢弃缓存值。这也会导致重新触发 Effect，因此 最好通过将对象移动到 Effect 内部来消除对函数的依赖：</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ 不需要将 useMemo 或对象作为依赖！</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>  serverUrl<span class="token punctuation">:</span> <span class="token string">'https://localhost:1234'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">:</span> roomId <span class="token punctuation">}</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">createConnection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> connection<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>roomId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✅ 只有当 roomId 改变时才会被改变</span>
</code></pre></div><p>4、记忆一个函数，这个跟另外一个 hooks 的 useCallback 方法一样。像 <code>function() {}</code> 这样的函数声明和像 <code>() =&gt; {}</code> 这样的表达式在每次重新渲染时都会产生一个 <strong>不同</strong> 的函数。就其本身而言，创建一个新函数不是问题。这不是可以避免的事情！但是，如果 <code>Form</code> 组件被记忆了，大概你想在没有 props 改变时跳过它的重新渲染。<strong>总是</strong> 不同的 props 会破坏你的记忆化。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ProductPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> productId<span class="token punctuation">,</span> referrer <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">handleSubmit</span><span class="token punctuation">(</span>orderDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/product/'</span> <span class="token operator">+</span> productId <span class="token operator">+</span> <span class="token string">'/buy'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> referrer<span class="token punctuation">,</span> orderDetails <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 使用 useMemo 记忆 handleSubmit 函数</span>
  <span class="token keyword">const</span> handleSubmit <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>orderDetails<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/product/'</span> <span class="token operator">+</span> productId <span class="token operator">+</span> <span class="token string">'/buy'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> referrer<span class="token punctuation">,</span> orderDetails <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>productId<span class="token punctuation">,</span> referrer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如何衡量计算过程的开销是否昂贵？</p> <p>一般来说，除非要创建或循环遍历数千个对象，否则开销可能并不大。如果你想获得更详细的信息，可以在控制台来测量花费这上面的时间：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'filter array'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> visibleTodos <span class="token operator">=</span> <span class="token function">filterTodos</span><span class="token punctuation">(</span>todos<span class="token punctuation">,</span> tab<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'filter array'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用 useMemo 测试</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'filter array useMemo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> visibleTodos <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">filterTodos</span><span class="token punctuation">(</span>todos<span class="token punctuation">,</span> tab<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> tab<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'filter array useMemo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后执行你正在监测的交互（例如，在输入框中输入文字）。你将会在控制台看到如下的日志 <code>filter array: 0.15ms</code>。如果全部记录的时间加起来很长（<code>1ms</code> 或者更多），那么记忆此计算结果是有意义的。作为对比，你可以将计算过程包裹在 <code>useMemo</code> 中，以验证该交互的总日志时间是否减少了。</p> <p>请记住，你的开发设备可能比用户的设备性能更强大，因此最好人为降低当前浏览器性能来测试。例如，Chrome 提供了 <a href="https://developer.chrome.com/blog/new-in-devtools-61/#throttling" target="_blank" rel="noopener noreferrer">CPU Throttling<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 选项来降低浏览器性能。另外，请注意，在开发环境中测量性能无法为你提供最准确的结果（例如，当开启 <a href="https://zh-hans.react.dev/reference/react/StrictMode" target="_blank" rel="noopener noreferrer">严格模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 时，你会看到每个组件渲染两次而不是一次）。要获得最准确的时间，请构建用于生产的应用程序并在用户使用的设备上对其进行测试。</p> <p>官方文档：https://zh-hans.react.dev/reference/react/useMemo</p> <h3 id="_5-2-usecallback"><a href="#_5-2-usecallback" aria-hidden="true" class="header-anchor">#</a> 5.2 useCallback</h3> <p>useMemo 和 useCallback 接收的参数都是一样，都是在其依赖项发生变化后才执行，都是返回缓存的值，区别在于 useMemo 返回的是函数运行的结果，useCallback 返回的是函数。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> cachedFn <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> deps<span class="token punctuation">)</span>
<span class="token comment">// useCallback 等于 如下实现，或者 const cachedFn = useMemo(() =&gt; fn, dependencies)</span>
<span class="token keyword">function</span> <span class="token function">myUseCallback</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn<span class="token punctuation">,</span> dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>fn：想要缓存的函数。在初次渲染时，React 将把函数返回给你。在之后的渲染中会根据 <code>deps</code> 参数情况而定。</li> <li>deps：类型是数组，作为执行 useCallback 的依赖项。跟 useMemo 方法的参数一样。</li> <li>cachedFn：缓存函数的名字</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">/* 用react.memo */</span>
<span class="token keyword">const</span> DemoChildren <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">/* 只有初始化的时候打印了 子组件更新 */</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子组件更新'</span><span class="token punctuation">)</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> props<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token string">'子组件'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">子组件</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">DemoUseCallback</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> getInfo  <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sonName<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sonName<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 点击按钮触发父组件更新 ，但是子组件没有更新 */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setNumber</span><span class="token punctuation">(</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">增加</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DemoChildren</span> <span class="token attr-name">getInfo</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>getInfo<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>与字面量对象 <code>{}</code> 总是会创建新对象类似，<strong>在 JavaScript 中，<code>function () {}</code> 或者 <code>() =&gt; {}</code> 总是会生成不同的函数</strong>。正常情况下，这不会有问题。但是在函数组件中，把函数传给子组件的props。这会导致每次渲染props都是不同的。并且 <a href="https://zh-hans.react.dev/reference/react/memo" target="_blank" rel="noopener noreferrer"><code>memo</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对性能的优化永远不会生效。而这就是 <code>useCallback</code> 起作用的地方。</p> <p>官方文档：https://zh-hans.react.dev/reference/react/useCallback</p> <h2 id="_6-工具-hooks"><a href="#_6-工具-hooks" aria-hidden="true" class="header-anchor">#</a> 6. 工具 hooks</h2> <h3 id="_6-1-usedebugvalue"><a href="#_6-1-usedebugvalue" aria-hidden="true" class="header-anchor">#</a> 6.1 useDebugValue</h3> <p>可以让你在 <a href="https://zh-hans.react.dev/learn/react-developer-tools" target="_blank" rel="noopener noreferrer">React 开发工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中为自定义 Hook 添加标签。<strong>注意</strong>：只有自定义hooks组件才有效，其他函数组件无效。并且需要浏览器安装 <a href="https://zh-hans.react.dev/learn/react-developer-tools" target="_blank" rel="noopener noreferrer">React 开发工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件。</p> <p>使用方法、参数说明：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token function">useDebugValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> date <span class="token operator">=&gt;</span> date<span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>value</code>：你想在 React 开发工具中显示的值。可以是任何类型。</li> <li><strong>可选</strong> <code>format</code>：它接受一个格式化函数。当组件被检查时，React 开发工具将用 <code>value</code> 作为参数来调用格式化函数，然后显示返回的格式化值（可以是任何类型）。如果不指定格式化函数，则会显示 <code>value</code>。在某些情况下，格式化值的显示可能是一项开销很大的操作。除非需要检查 Hook，否则没有必要这么做。</li></ul> <p>使用例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">useTestDebug</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// const [age, setAge] = React.useState(11);</span>
  React<span class="token punctuation">.</span><span class="token function">useDebugValue</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useTestDebug</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">add count</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    count: </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>浏览器终端显示：</p> <p><img src="/assets/img/026-hooks.1e757a36.png" alt></p> <p>官方文档：https://zh-hans.react.dev/reference/react/useDebugValue</p> <h3 id="_6-2-useid"><a href="#_6-2-useid" aria-hidden="true" class="header-anchor">#</a> 6.2 useId</h3> <p>useId 也是 React v18 产生的新的 hooks , 它可以在 client 和 server 生成唯一的 id , 解决了在服务器渲染中，服务端和客户端产生 id 不一致的问题，更重要的是保障了 React v18 中 <strong>streaming renderer （流式渲染）</strong> 中 id 的稳定性。</p> <p><strong>低版本 React ssr 存在的问题：</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> rid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_id_'</span>  <span class="token comment">/* 生成一个随机id  */</span>
<span class="token keyword">function</span> <span class="token function">Demo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>rid<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> <span class="token comment">// 使用 rid </span>
<span class="token punctuation">}</span>
</code></pre></div><p>这在纯客户端渲染中没有问题，但是在服务端渲染的时候，传统模式下需要走如下流程。在这个过程中，当服务端渲染到 html 和 hydrate 过程分别在服务端和客户端进行，但是会走两遍 id 的生成流程，这样就会造成 id不一致的情况发生。useId 的出现能有效的解决这个问题。</p> <p><img src="/assets/img/027-hooks.db530d81.png" alt></p> <p><strong>useId 基本用法:</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Demo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> rid <span class="token operator">=</span> <span class="token function">useId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 生成稳定的 id </span>
   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>rid<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-2-1-v18-ssr"><a href="#_6-2-1-v18-ssr" aria-hidden="true" class="header-anchor">#</a> 6.2.1 v18 ssr</h3> <p>这部分转载自：https://juejin.cn/post/7118937685653192735#heading-23</p> <p>在 React v18 中 对 ssr 增加了流式渲染的特性 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactwg%2Freact-18%2Fdiscussions%2F37" target="_blank" rel="noopener noreferrer">New Suspense SSR Architecture in React 18 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>， 那么这个特性是什么呢？我们来看一下：</p> <p>在传统 React ssr 中，如果正常情况下， hydrate 过程如下所示：</p> <p><img src="/assets/img/028-hooks.c24b9fc2.png" alt></p> <p>刚开始的时候，因为服务端渲染，只会渲染 html 结构，此时还没注入 js 逻辑，所以我们把它用灰色不能交互的模块表示。（如上灰色的模块不能做用户交互，比如点击事件之类的。）</p> <p>hydrate js 加载之后，此时的模块可以正常交互，所以用绿色的模块展示。</p> <p>但是如果其中一个模块，服务端请求数据，数据量比较大，耗费时间长，我们不期望在服务端完全形成 html 之后在渲染，那么 React 18 给了一个新的可能性。可以使用  包装页面的一部分，然后让这一部分的内容先挂起。</p> <p>接下来会通过 script 加载 js 的方式 流式注入 html 代码的片段，来补充整个页面。接下来的流程如下所示：</p> <p><img src="/assets/img/029-hooks.e056fa7b.png" alt></p> <p>在这个原理基础之上， React 个特性叫 Selective Hydration，可以<strong>根据用户交互改变 hydrate 的顺序</strong>。</p> <p>比如有两个模块都是通过 Suspense 挂起的，当两个模块发生交互逻辑时，会根据交互来选择性地改变 hydrate 的顺序。</p> <p><img src="/assets/img/030-hooks.fc7f28d6.png" alt></p> <p>如上 C D 选择性的 hydrate 就是 Selective Hydration 的结果。那么回到主角 useId 上，如果在 hydrate 过程中，C D 模块 id 是动态生成的，比如如下：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">function</span> <span class="token function">makeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> id<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span> <span class="token function">makeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span>  <span class="token punctuation">&gt;</span></span><span class="token plain-text">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么如果组件是 Selective Hydration , 那么注册组件的顺序服务端和客户端有可能不统一，这样表现就会不一致了。那么用 useId 动态生成 id 就不会有这个问题产生了，所以说 useId 保障了 React v18 中 <strong>streaming renderer （流式渲染）</strong> 中 id 的稳定性。</p> <h2 id="_7-函数组件使用注意事项"><a href="#_7-函数组件使用注意事项" aria-hidden="true" class="header-anchor">#</a> 7. 函数组件使用注意事项</h2> <h3 id="_7-1-关于严格模式hooks的影响"><a href="#_7-1-关于严格模式hooks的影响" aria-hidden="true" class="header-anchor">#</a> 7.1 关于严格模式hooks的影响</h3> <p>严格模式启用了以下仅在开发环境下有效的行为：</p> <ul><li><p>组件将 <a href="https://zh-hans.react.dev/reference/react/StrictMode#fixing-bugs-found-by-double-rendering-in-development" target="_blank" rel="noopener noreferrer">额外重新渲染一次<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 以查找由于非纯渲染而引起的错误。</p></li> <li><p>组件将 <a href="https://zh-hans.react.dev/reference/react/StrictMode#fixing-bugs-found-by-re-running-effects-in-development" target="_blank" rel="noopener noreferrer">额外重新运行一次 Effect <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>以查找由于缺少 Effect 清理而引起的错误。</p></li> <li><p>组件将 <a href="https://zh-hans.react.dev/reference/react/StrictMode#fixing-bugs-found-by-re-running-ref-callbacks-in-development" target="_blank" rel="noopener noreferrer">额外重新运行一次 refs 回调<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 以查找由于缺少 ref 清理函数而引起的错误。</p></li> <li><p>组件将被 <a href="https://zh-hans.react.dev/reference/react/StrictMode#fixing-deprecation-warnings-enabled-by-strict-mode" target="_blank" rel="noopener noreferrer">检查是否使用了已弃用的 API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></li> <li><p>Effect 方法：修复在开发中通过重新运行 Effect 发现的错误。React 会在实际运行 setup 之前额外运行一次 setup 和 cleanup。这是一个压力测试，用于验证 Effect 的逻辑是否正确实现。如果出现可见问题，则 cleanup 函数缺少某些逻辑。cleanup 函数应该停止或撤消 setup 函数所做的任何操作。一般来说，用户不应该能够区分 setup 被调用一次（如在生产环境中）和调用 setup → cleanup → setup 序列（如在开发环境中）。</p></li> <li><p>函数组件中的方法(useMemo)：React 将调用你的某些函数两次而不是一次，这是符合预期的，不应对你的代码逻辑产生影响。这种 <strong>仅限开发环境下的</strong> 行为可帮助你 <a href="https://zh-hans.react.dev/learn/keeping-components-pure" target="_blank" rel="noopener noreferrer">保持组件纯粹<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。React 使用其中一次调用的结果，而忽略另一次的结果。只要你的组件和计算函数是纯函数，这就不会影响你的逻辑。但是，如果你不小心写出带有副作用的代码，这可以帮助你发现并纠正错误。</p></li></ul> <p>严格模式官方文档：https://zh-hans.react.dev/reference/react/useMemo</p> <p>当发现hooks 某些方法执行了两次可以考虑是否开启了严格模式。</p> <h2 id="_8-hooks-使用规则"><a href="#_8-hooks-使用规则" aria-hidden="true" class="header-anchor">#</a> 8. hooks 使用规则</h2> <p>参考资料：</p> <p>https://juejin.cn/post/7020811068955951135</p> <p>https://zh-hans.legacy.reactjs.org/docs/hooks-rules.html</p> <p>在<a href="https://zh-hans.legacy.reactjs.org/docs/hooks-rules.html" target="_blank" rel="noopener noreferrer">react 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中说明了使用hooks的两个规则：</p> <blockquote><h3 id="_1、只在最顶层使用-hook。不要在循环，条件或嵌套函数中调用-hook"><a href="#_1、只在最顶层使用-hook。不要在循环，条件或嵌套函数中调用-hook" aria-hidden="true" class="header-anchor">#</a> 1、只在最顶层使用 Hook。不要在循环，条件或嵌套函数中调用 Hook</h3> <p>确保总是在你的 React 函数的最顶层调用他们。遵守这条规则，你就能确保 Hook 在每一次渲染中都按照同样的顺序被调用。这让 React 能够在多次的 <code>useState</code> 和 <code>useEffect</code> 调用之间保持 hook 状态的正确。</p> <h3 id="_2、只在-react-函数中调用-hook。不要在普通的-javascript-函数中调用-hook。你可以："><a href="#_2、只在-react-函数中调用-hook。不要在普通的-javascript-函数中调用-hook。你可以：" aria-hidden="true" class="header-anchor">#</a> 2、只在 React 函数中调用 Hook。不要在普通的 JavaScript 函数中调用 Hook。你可以：</h3> <ul><li>✅ 在 React 的函数组件中调用 Hook</li> <li>✅ 在自定义 Hook 中调用其他 Hook</li></ul></blockquote> <p>这些规则确保了<code>Hooks</code>的调用顺序在多次渲染之间保持一致。由于<code>React</code>内部没有办法追踪到底有多少个状态或副作用需要被管理，它依赖于<code>Hooks</code>的调用顺序来关联状态和副作用。</p> <h3 id="_8-1-为什么不能在循环、条件或嵌套函数中调用hooks"><a href="#_8-1-为什么不能在循环、条件或嵌套函数中调用hooks" aria-hidden="true" class="header-anchor">#</a> 8.1 为什么不能在循环、条件或嵌套函数中调用Hooks</h3> <p>这么做的主要原因是<strong>保证有序调用hooks</strong>。React依赖于Hooks调用的顺序来正确地关联Hook的状态。如果在循环或条件语句中调用Hooks，每次迭代或条件判断都可能产生新的Hook状态，这会导致React无法正确地关联状态和更新。</p> <p>1、每次调用 <code>hooks</code> 都会生成 <code>hook</code> 对象，在函数组件中多次使用<code>hooks</code>，这会产生多个 <code>hook</code> 对象，这些<code>hook</code> 对象通过对象内的<code>next</code>属性连接形成链表，连接是在挂载时进行的，</p> <p>2、在更新时，每个hooks对象都是调用更新函数处理生成新的hook对象并连接形成hook链以供下次更新时使用。</p> <p>3、正确使用hooks时，遍历hook链，复用hook上次更新的hook，没有问题，但如果某个hooks的调用与否是有条件的，那么情况就不同了。举个简单例子，如下使用hooks：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">FunComponent</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>counter<span class="token punctuation">,</span> setCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> memo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.1 假设第一次更新时<code>props.condition === true</code>，那么 hook链是这样的：<code>useEffect hook</code> =&gt; <code>useState hook</code> =&gt;<code>useMemo hook</code>。<br>
3.2 第二次更新时<code>props.condition === false</code>，useState首先执行，由于上一次的 hooks 链第一个是useEffect，返回的是<code>effect</code>对象，<code>counter</code>从数字变成了对象，渲染或利用<code>counter</code>计算时肯定会报错的。</p> <h3 id="_8-2-为什么只能在函数组件中调用-hooks-？"><a href="#_8-2-为什么只能在函数组件中调用-hooks-？" aria-hidden="true" class="header-anchor">#</a> 8.2 为什么只能在函数组件中调用 hooks ？</h3> <p>我们使用的hooks函数中都没有直接实现代码，而是调用一个叫做<code>dispatcher</code>的对象中相应函数。<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2Fmain%2Fpackages%2Freact%2Fsrc%2FReactHooks.js%23L74" target="_blank" rel="noopener noreferrer">源码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>函数组件是在 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2Fmain%2Fpackages%2Freact-reconciler%2Fsrc%2FReactFiberHooks.new.js%23L370" target="_blank" rel="noopener noreferrer">renderWithHooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数内执行的。</p> <p>因此只有函数当组件去使用才会调用hooks相关功能去实现hooks，</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/yulilong/front-end-doc/edit/master/doc/react/009-hooks.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/15/2024, 10:53:13 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/doc/react/009-react-Hook.html" class="prev">
          react Hook
        </a></span> <span class="next"><a href="/doc/react/010-diff算法和性能优化.html">
          react diff 算法和性能优化
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/18.958e91d3.js" defer></script><script src="/assets/js/app.2afb8482.js" defer></script>
  </body>
</html>

(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{218:function(t,s,a){t.exports=a.p+"assets/img/001-cache.9c39add4.png"},219:function(t,s,a){t.exports=a.p+"assets/img/002-cache.ef65e68e.png"},220:function(t,s,a){t.exports=a.p+"assets/img/003-cache.4b666fa3.png"},221:function(t,s,a){t.exports=a.p+"assets/img/004-cache.38aab411.png"},540:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#_1-前端缓存-后端缓存"}},[t._v("1. 前端缓存/后端缓存")])]),a("li",[a("a",{attrs:{href:"#_2-本地缓存存放位置"}},[t._v("2. 本地缓存存放位置")]),a("ul",[a("li",[a("a",{attrs:{href:"#_2-1-service-worker"}},[t._v("2.1 Service Worker")])]),a("li",[a("a",{attrs:{href:"#_2-2-memory-cache"}},[t._v("2.2 memory cache")])]),a("li",[a("a",{attrs:{href:"#_2-3-disk-cache"}},[t._v("2.3 disk cache")])]),a("li",[a("a",{attrs:{href:"#_2-4-请求网络"}},[t._v("2.4 请求网络")])])])]),a("li",[a("a",{attrs:{href:"#_3-强缓存-协商缓存"}},[t._v("3. 强缓存/协商缓存")]),a("ul",[a("li",[a("a",{attrs:{href:"#_3-1-强制缓存-强缓存"}},[t._v("3.1 强制缓存(强缓存)")])]),a("li",[a("a",{attrs:{href:"#_3-2-协商缓存-对比缓存"}},[t._v("3.2 协商缓存(对比缓存)")])])])]),a("li",[a("a",{attrs:{href:"#_4-用户行为对浏览器缓存的影响"}},[t._v("4. 用户行为对浏览器缓存的影响")])]),a("li",[a("a",{attrs:{href:"#_5-缓存实际应用nodejs"}},[t._v("5. 缓存实际应用nodejs")]),a("ul",[a("li",[a("a",{attrs:{href:"#_5-1-强缓存expires实践"}},[t._v("5.1 强缓存Expires实践")])]),a("li",[a("a",{attrs:{href:"#_5-2-强缓存cache-control实践"}},[t._v("5.2 强缓存Cache-Control实践")])]),a("li",[a("a",{attrs:{href:"#_5-3-协商缓存etag实践"}},[t._v("5.3 协商缓存Etag实践")])]),a("li",[a("a",{attrs:{href:"#_5-4-协商缓存last-modified实践"}},[t._v("5.4 协商缓存Last-Modified实践")])])])]),a("li",[a("a",{attrs:{href:"#参考资料"}},[t._v("参考资料")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"浏览器缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#浏览器缓存","aria-hidden":"true"}},[this._v("#")]),this._v(" 浏览器缓存")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("减少了冗余的数据传输，节省网费")]),this._v(" "),s("li",[this._v("减少服务器的负担，提升网站性能")]),this._v(" "),s("li",[this._v("加快了客户端加载网页的速度")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("服务器更新资源后，由于缓存策略，导致用户浏览的页面还是旧的资源")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(218),alt:""}}),this._v("\n图片转载自：https://github.com/amandakelake/blog/issues/43")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_1-前端缓存-后端缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-前端缓存-后端缓存","aria-hidden":"true"}},[this._v("#")]),this._v(" 1. 前端缓存/后端缓存")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("后端的缓存主要集中在"),s("code",[this._v("处理")]),this._v("步骤，通过保留数据库连接，存储处理结果等方式，缩短处理时间，尽快进入响应的步骤。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("而前端的缓存则在"),s("code",[this._v("请求")]),this._v("、"),s("code",[this._v("响应")]),this._v("中进行。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_2-本地缓存存放位置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-本地缓存存放位置","aria-hidden":"true"}},[this._v("#")]),this._v(" 2. 本地缓存存放位置")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("在Google的Chrome浏览器的开发者工具中， "),a("code",[t._v("Network -> Size")]),t._v("一列中,可以看到一个请求最终的处理方式：如果是大小 (多少 K， 多少 M 等) 就表示是网络请求，否则会列出 "),a("code",[t._v("from memory cache")]),t._v(", "),a("code",[t._v("from disk cache")]),t._v(" 和 "),a("code",[t._v("from ServiceWorker")]),t._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("Service Worker")]),this._v(" "),s("li",[this._v("Memory Cache")]),this._v(" "),s("li",[this._v("Disk Cache")]),this._v(" "),s("li",[this._v("网络请求")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_2-1-service-worker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-service-worker","aria-hidden":"true"}},[this._v("#")]),this._v(" 2.1 Service Worker")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Service Worker能够操作的缓存是有别于浏览器内部的 "),s("code",[this._v("memory cache")]),this._v("或者"),s("code",[this._v("disk cache")]),this._v("方式。\n我们可以在Chrome的开发者工具中， Application - Application - Service Workers 找到。\nService Worker缓存是永久性的，即关闭TAB或者浏览器，下次打开依然还在(memory cache 不是)。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("手动调用API"),s("code",[this._v("cache.delete(resource)")])]),this._v(" "),s("li",[this._v("容量超过限制，被浏览器全部清空")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("如果Service Worker 没能命中缓存，一般情况会使用"),a("code",[t._v("fetch()")]),t._v("方法继续获取资源。这时候，浏览器就去"),a("code",[t._v("memory cache")]),t._v("或者"),a("code",[t._v("disk cache")]),t._v("进行下一次找缓存的工作了。注意：经过 Service Worker 的 "),a("code",[t._v("fetch()")]),t._v(" 方法获取的资源，即便它并没有命中 Service Worker 缓存，甚至实际走了网络请求，也会标注为 "),a("code",[t._v("from ServiceWorker")]),t._v("。这个情况在后面的第三个示例中有所体现。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_2-2-memory-cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-memory-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" 2.2 memory cache")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("几乎所有的网络请求资源都会被浏览器自动加入到"),s("code",[this._v("memory cache")]),this._v("中。由于资源数量多和内存大小的限制，"),s("code",[this._v("memory cache")]),this._v('只能是"短期存储"。一般情况下，浏览器TAB标签页关闭后，该次浏览的'),s("code",[this._v("memory cache")]),this._v("便会失效(给其他TAB留出内存空间)。在极端情况下(例如一个页面的缓存占用了超级多的内存)，那么TAB没关闭之前，排在前面的缓存就已经失效了。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("刚才提过，"),s("strong",[this._v("几乎所有的请求资源")]),this._v(" 都能进入 memory cache，这里细分一下主要有两块：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这就是 preloader 要做的事情。不过 preloader 没有一个官方标准，所以每个浏览器的处理都略有区别。例如有些浏览器还会下载 css 中的 "),s("code",[this._v("@import")]),this._v(" 内容或者 "),s("code",[this._v("<video>")]),this._v(" 的 "),s("code",[this._v("poster")]),this._v("等。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("preload (虽然看上去和刚才的 preloader 就差了俩字母)。实际上这个大家应该更加熟悉一些，例如 "),s("code",[this._v('<link rel="preload">')]),this._v("。这些显式指定的预加载资源，也会被放入 memory cache 中。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("memory cache 机制保证了一个页面中如果有两个相同的请求 (例如两个 "),a("code",[t._v("src")]),t._v(" 相同的 "),a("code",[t._v("<img>")]),t._v("，两个 "),a("code",[t._v("href")]),t._v(" 相同的 "),a("code",[t._v("<link>")]),t._v(")都实际只会被请求最多一次，避免浪费。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("不过在匹配缓存时，除了匹配完全相同的 URL 之外，还会比对他们的类型，CORS 中的域名规则等。因此一个作为脚本 (script) 类型被缓存的资源是不能用在图片 (image) 类型的请求中的，即便他们 "),s("code",[this._v("src")]),this._v(" 相等。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("在从 memory cache 获取缓存内容时，浏览器会忽视例如 "),a("code",[t._v("max-age=0")]),t._v(", "),a("code",[t._v("no-cache")]),t._v(" 等头部配置。例如页面上存在几个相同 "),a("code",[t._v("src")]),t._v(" 的图片，即便它们可能被设置为不缓存，但依然会从 memory cache 中读取。这是因为 memory cache 只是短期使用，大部分情况生命周期只有一次浏览而已。而 "),a("code",[t._v("max-age=0")]),t._v(" 在语义上普遍被解读为“不要在下次浏览时使用”，所以和 memory cache 并不冲突。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("但如果服务器(网站服务)是真心不想让一个资源进入缓存，就连短期也不行，那就需要使用 "),s("code",[this._v("no-store")]),this._v("。存在这个头部配置的话，即便是 memory cache 也不会存储，自然也不会从中读取了。(后面的第二个示例有关于这点的体现)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_2-3-disk-cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-disk-cache","aria-hidden":"true"}},[this._v("#")]),this._v(" 2.3 disk cache")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("disk cache")]),this._v("也叫"),s("code",[this._v("HTTP cache")]),this._v("，是存储在硬盘上的缓存，因此它是持久存储的，是实际存在于文件系统中的。而且它允许相同的资源在跨会话，甚至跨站点的情况下使用，例如两个站点都使用了同一张图片。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("凡是持久性的存储都会面临容量增长的问题，disk cache也不例外。在浏览器自动清理时，会有神秘的算法去把"),a("code",[t._v("最老的")]),t._v("或者"),a("code",[t._v("最可能过时")]),t._v("的资源删除，是一个一个删除的。每个浏览器识别"),a("code",[t._v("最老的")]),t._v("或者"),a("code",[t._v("最可能过时")]),t._v("的资源的算法不尽相同。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_2-4-请求网络"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-请求网络","aria-hidden":"true"}},[this._v("#")]),this._v(" 2.4 请求网络")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("根据 Service Worker 中的 handler 决定是否存入 Cache Storage (额外的缓存位置)。")]),t._v(" "),a("li",[t._v("根据 HTTP 头部的相关字段("),a("code",[t._v("Cache-control")]),t._v(", "),a("code",[t._v("Pragma")]),t._v(" 等)决定是否存入 disk cache")]),t._v(" "),a("li",[t._v("memory cache 保存一份资源 "),a("strong",[t._v("的引用")]),t._v("，以备下次使用。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_3-强缓存-协商缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-强缓存-协商缓存","aria-hidden":"true"}},[this._v("#")]),this._v(" 3. 强缓存/协商缓存")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("memory cache 是浏览器为了加快读取缓存速度而进行的自身的优化行为，不受开发者控制，也不受 HTTP 协议头的约束，算是一个黑盒。Service Worker 是由开发者编写的额外的脚本，且缓存位置独立，出现也较晚，使用还不算太广泛。所以我们平时最为熟悉的其实是 disk cache，也叫 HTTP cache (因为不像 memory cache，它遵守 HTTP 协议头中的字段)。平时所说的强制缓存，对比缓存，以及 "),s("code",[this._v("Cache-Control")]),this._v(" 等，也都归于此类。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("强制缓存优先于协商缓存进行，若强制缓存(Expires和Cache-Control)生效则直接使用缓存，若不生效则进行协商缓存(Last-Modified / If-Modified-Since和Etag / If-None-Match)，协商缓存由服务器决定是否使用缓存，若协商缓存失效，那么代表该请求的缓存失效，返回200，重新返回资源和缓存标识，再存入浏览器缓存中；生效则返回304，继续使用缓存")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_3-1-强制缓存-强缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-强制缓存-强缓存","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.1 强制缓存(强缓存)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("强缓存是通过后端在响应头中设置字段"),s("code",[this._v("Cache-control")]),this._v("和"),s("code",[this._v("Expire")]),this._v("实现的。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-1-1-expires：缓存到期时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-expires：缓存到期时间","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.1.1 Expires：缓存到期时间")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("Expires: Mon, 02 Sep 2019 15:37:19 GMT\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(219),alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-1-2-cache-control：缓存控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-cache-control：缓存控制","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.1.2 Cache-Control：缓存控制")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("由于Expires的缺点，在HTTP 1.1 版本中，增加了一个字段"),s("code",[this._v("Cache-Control")]),this._v("，该字段表示资源缓存的最大有效时间，在该时间内，浏览器不需要向服务器发送请求。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("Cache-Control: max-age"),s("span",{attrs:{class:"token operator"}},[this._v("=")]),this._v("600\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("字段")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("max-age")]),t._v(" "),a("td",[t._v("最大有效时间，单位秒，在请求返回到浏览器那一刻开始算")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("must-revalidate")]),t._v(" "),a("td",[t._v("如果时间超过了"),a("code",[t._v("mag-age")]),t._v("，浏览器必须向服务器发送请求，验证资源是否失效。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("no-cache")]),t._v(" "),a("td",[t._v("需要使用协商缓存来验证缓存数据")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("no-store")]),t._v(" "),a("td",[t._v("不要缓存，所有内容都不缓存，包括强制缓存和协商缓存")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("public")]),t._v(" "),a("td",[t._v("响应可以被任何对象(浏览器、代理服务器、CDN等等)缓存")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("private")]),t._v(" "),a("td",[t._v("默认值。响应内容只有浏览器客户端才能缓存，代理服务器不能缓存。")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这些值可以混合使用，例如 "),s("code",[this._v("Cache-control:public, max-age=2592000")]),this._v("。在混合使用时，它们的优先级如下图：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(220),alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-1-3-max-age-0-和-no-cache区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-max-age-0-和-no-cache区别","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.1.3 max-age=0 和 no-cache区别")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("从规范的字面意思来说，"),a("code",[t._v("max-age")]),t._v(" 到期是 "),a("strong",[t._v("应该(SHOULD)")]),t._v(" 重新验证，而 "),a("code",[t._v("no-cache")]),t._v(" 是 "),a("strong",[t._v("必须(MUST)")]),t._v(" 重新验证。但实际情况以浏览器实现为准，大部分情况他们俩的行为还是一致的。（如果是 "),a("code",[t._v("max-age=0, must-revalidate")]),t._v(" 就和 "),a("code",[t._v("no-cache")]),t._v(" 等价了）")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("顺带一提，在 HTTP/1.1 之前，如果想使用 "),a("code",[t._v("no-cache")]),t._v("，通常是使用 "),a("code",[t._v("Pragma")]),t._v(" 字段，如 "),a("code",[t._v("Pragma: no-cache")]),t._v("(这也是 "),a("code",[t._v("Pragma")]),t._v(" 字段唯一的取值)。但是这个字段只是浏览器约定俗成的实现，并没有确切规范，因此缺乏可靠性。它应该只作为一个兼容字段出现，在当前的网络环境下其实用处已经很小。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("总结一下，自从 HTTP/1.1 开始，"),a("code",[t._v("Expires")]),t._v(" 逐渐被 "),a("code",[t._v("Cache-control")]),t._v(" 取代。"),a("code",[t._v("Cache-control")]),t._v(" 是一个相对时间，即使客户端时间发生改变，相对时间也不会随之改变，这样可以保持服务器和客户端的时间一致性。而且 "),a("code",[t._v("Cache-control")]),t._v(" 的可配置性比较强大。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("Cache-control 的优先级高于 Expires")]),this._v("，为了兼容 HTTP/1.0 和 HTTP/1.1，实际项目中两个字段我们都会设置。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_3-2-协商缓存-对比缓存"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-协商缓存-对比缓存","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2 协商缓存(对比缓存)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("协商缓存在发送请求上和没有缓存的请求是一致的，但如果响应的状态码是304的话，则仅仅是返回一个状态码而已，并没有实际的文件内容，因此在"),s("code",[this._v("响应体体积上节省")]),this._v("是它的优点，协商缓存优化了请求的响应，通过减少响应体体积，来缩短网络传输时间。协商缓存比强制缓存节省时间的提升幅度小，但总比没有缓存的好。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("协商缓存有两组字段："),s("code",[this._v("Last-Modified & If-Modified-Since")]),this._v("和"),s("code",[this._v("Etag & If-None-Match")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-2-1-资源最后修改时间：last-modified-服务器返回的-if-modified-since-请求携带的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-资源最后修改时间：last-modified-服务器返回的-if-modified-since-请求携带的","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2.1 资源最后修改时间：Last-Modified(服务器返回的) & If-Modified-Since(请求携带的)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("1、服务器通过"),s("code",[this._v("Last-Modified")]),this._v("字段通知客户端，资源最后一次修改的时间，如：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[this._v("Last-Modified: Mon, 02 Sep 2019 06:30:14 GMT\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("3、下一次请求相同资源时，浏览器从自己的缓存中找出"),s("code",[this._v("不确定是否过期")]),this._v("的缓存。因此在请求头中将上次的"),s("code",[this._v("Last-Modified")]),this._v("的值写入到请求头的"),s("code",[this._v("If-Modified-Since")]),this._v("字段。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("4、服务器会将"),s("code",[this._v("If-Modified-Since")]),this._v("的值与"),s("code",[this._v("Last-Modified")]),this._v("的值进行对比。如果相等，则表示未修改，响应状态码304。反之则表示修改内容了，响应状态码200，并返回数据。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("由于Last-Modified有上面的缺点，所以在 HTTP 1.1 版本中出现了"),s("code",[this._v("ETag")]),this._v(" 和"),s("code",[this._v("If-None-Match")]),this._v(":资源文件的一个唯一标识")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-2-2-资源唯一标识：etag-服务器返回文件标识-if-none-match-请求发送的标识"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-资源唯一标识：etag-服务器返回文件标识-if-none-match-请求发送的标识","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2.2 资源唯一标识：Etag(服务器返回文件标识) & If-None-Match(请求发送的标识)")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("Etag是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，只要资源有变化，Etag就会重新生成")]),this._v("。浏览器在下一次加载资源向服务器发送请求时，会将上一次返回的Etag值放到request header里的If-None-Match里，服务器只需要比较客户端传来的If-None-Match跟自己服务器上该资源的ETag是否一致，就能很好地判断资源相对客户端而言是否被修改过了。如果服务器发现ETag匹配不上，那么直接以常规GET 200回包形式将新的资源（当然也包括了新的ETag）发给客户端；如果ETag是一致的，则直接返回304知会客户端直接使用本地缓存即可。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h4",{attrs:{id:"_3-2-3-last-modified和etag对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-last-modified和etag对比","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2.3 Last-Modified和Etag对比")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_4-用户行为对浏览器缓存的影响"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-用户行为对浏览器缓存的影响","aria-hidden":"true"}},[this._v("#")]),this._v(" 4. 用户行为对浏览器缓存的影响")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("初次打开网页，地址栏输入地址：查找"),a("code",[t._v("disk cache")]),t._v("中是否有匹配。如果有则使用；没有则发送网络请求。")]),t._v(" "),a("li",[t._v("普通刷新(F5)：因为TAB标签页面没有关闭，因此"),a("code",[t._v("memory cache")]),t._v("是可用的，会被优先使用(如果匹配到)，其次才去"),a("code",[t._v("disk cache")]),t._v("中匹配。")]),t._v(" "),a("li",[t._v("强制刷新(Ctrl + F5)：浏览器不使用缓存，因此发送的请求头部均带有"),a("code",[t._v("Cache-Control:no-cache")]),t._v("(为了兼容，还带了"),a("code",[t._v("Pragma: no-cache")]),t._v(")，服务器直接返回200和最新的内容。")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_5-缓存实际应用nodejs"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-缓存实际应用nodejs","aria-hidden":"true"}},[this._v("#")]),this._v(" 5. 缓存实际应用nodejs")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("使用的是nodejs来搭建服务，如果没有node，请自行安装。")]),t._v(" "),a("li",[t._v("使用的是Google的Chrome浏览器")]),t._v(" "),a("li",[t._v("Mac下Chrome刷新快捷键是"),a("code",[t._v("cmd + R")]),t._v("，强制刷新快捷键是"),a("code",[t._v("shift + cmd + R")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{attrs:{class:"token doctype"}},[t._v("<!DOCTYPE html>")]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("lang")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("en"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("head")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("charset")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("UTF-8"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("title")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("测试文档"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("title")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("head")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("class")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("app"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("./001.png"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("alt")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v("'")]),t._v("./index.js"),a("span",{attrs:{class:"token punctuation"}},[t._v("'")])]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{attrs:{class:"token script language-javascript"}}),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("document"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("querySelector")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'.app'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("innerHTML "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'我是JS文件执行输入的！'")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'http'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" path "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'path'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" crypto "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'crypto'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  \tres"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("write")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" server "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" http"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("createServer")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" filePath "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" path"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("join")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{attrs:{class:"token comment"}},[t._v("// 获取文件路径")]),t._v("\n    fs"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("readFile")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("404")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'not found'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Oh, Not Found'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filepath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nserver"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("listen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("3000")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'listen to 3000 port'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v(".\n├── 001.png\n├── index.html\n├── index.js\n└── server.js\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("2、终端使用"),s("code",[this._v("node server.js")]),this._v("来启动服务，然后浏览器输入：http://localhost:3000/index.html，打开浏览器开发者工具，选择Network，就可以看见请求了，由于没有设置任何缓存字段，每次刷新页面，都会重新请求数据。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_5-1-强缓存expires实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-强缓存expires实践","aria-hidden":"true"}},[this._v("#")]),this._v(" 5.1 强缓存Expires实践")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// res.setHeader('Expires', 'Wed, 23 Jan 2019 07:40:51 GMT')")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 设置缓存5秒")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" date "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("now")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("1000")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token number"}},[t._v("5")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("toGMTString")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Expires'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" date"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("write")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("3、5秒内刷新，此时可以看到资源使用了缓存，使用的是"),s("code",[this._v("memory cache")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_5-2-强缓存cache-control实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-强缓存cache-control实践","aria-hidden":"true"}},[this._v("#")]),this._v(" 5.2 强缓存Cache-Control实践")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  \t"),a("span",{attrs:{class:"token comment"}},[t._v("// res.setHeader('Cache-Control', 'no-cache') // 不使用缓存")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 设置缓存5秒")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Cache-Control'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'max-age=5'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("write")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_5-3-协商缓存etag实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-协商缓存etag实践","aria-hidden":"true"}},[this._v("#")]),this._v(" 5.3 协商缓存Etag实践")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 获取客户端传来的Etag")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldEtag "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v("'if-none-match'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("oldEtag"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 如果不存在Etag，则新生成一个Etag")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" md5 "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" crypto"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("createHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'md5'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Etag'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" md5"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("update")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("digest")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'base64'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" newEtag "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" crypto"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("createHash")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'md5'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("update")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("digest")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'base64'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEtag "),a("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" newEtag"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("// 新旧Etag不一致，说明文件修改了。")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Etag'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEtag"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("// 文件没有修改，返回304，让客户端使用缓存数据")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("304")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("4、修改"),s("code",[this._v("index.js")]),this._v("文件(加几个空行)保存后，刷新浏览器，则该资源状态码变成200，是通过请求获取的资源。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:a(221),alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"_5-4-协商缓存last-modified实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-协商缓存last-modified实践","aria-hidden":"true"}},[this._v("#")]),this._v(" 5.4 协商缓存Last-Modified实践")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("processCache")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// 文件修改时间")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" mtime "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("parse")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("statSync")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filePath"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mtime"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v("'if-modified-since'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 没有请求")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Last-Modified'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtime"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("toGMTString")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldMtime "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("parse")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v("'if-modified-since'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtime "),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" oldMtime"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("// 文件更新了")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("setHeader")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Last-Modified'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtime"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("toGMTString")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'OK'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token comment"}},[t._v("// 没有更新使用缓存")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("writeHead")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("304")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("注意，这里刷新后，只有index.html文件是304， js文件和img文件都是直接使用了"),s("code",[this._v("memory cache")]),this._v("，只有设置了"),s("code",[this._v("res.setHeader('Cache-Control', 'no-cache')")]),this._v("效果才跟 协商缓存Etag一致。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[this._v("#")]),this._v(" 参考资料")])}],e=a(0),c=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[a("p"),t._m(0),a("p"),t._v(" "),a("p",[t._v("[TOC]")]),t._v(" "),t._m(1),t._v(" "),a("p",[t._v("浏览器缓存是浏览器将用户请求过的静态资源(html、css、js、img)，存储到用户电脑中，当浏览器再次访问时，就可以直接从本地加载了，不需要再去服务器请求了。")]),t._v(" "),a("p",[t._v("缓存的优点：")]),t._v(" "),t._m(2),t._v(" "),a("p",[t._v("缓存的缺点：")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),a("p",[t._v("基本的网络请求有三个步骤：请求、处理、响应。")]),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),a("p",[t._v("请求阶段：浏览器可以通过存储之前结果的方式直接使用资源，直接省去了发送的请求。")]),t._v(" "),a("p",[t._v("响应阶段：浏览器和服务器配合，通过减少响应内容来缩短传输时间。")]),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),a("p",[t._v("它们的优先级是：(由上到下寻找，找到即返回；找不到则继续)")]),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),a("p",[t._v("memory cache 和 disk cache 的缓存策略以及缓存/读取/失效的操作都是由浏览器内部判断&进行的，我们只能设置响应头的某些字段来告诉浏览器，不能自己操作。")]),t._v(" "),a("p",[t._v("Service Worker的出现，给予了我们另外一种更加灵活，更加直接的操作方式。可以通过Service Worker来自己实现、控制缓存策略以及缓存/读取/失效的操作。")]),t._v(" "),t._m(12),t._v(" "),a("p",[t._v("有两种情况会导致这个缓存中的资源被清除：")]),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),a("p",[t._v("memory cache是内存中的缓存。按照操作系统的常理：先读内存，再度硬盘。")]),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),a("ol",[a("li",[a("p",[t._v("preloader(预加载网路资源)：")]),t._v(" "),a("p",[t._v("熟悉浏览器处理流程的同学们应该了解，在浏览器打开网页的过程中，会先请求 HTML 然后解析。之后如果浏览器发现了 js, css 等需要解析和执行的资源时，它会使用 CPU 资源对它们进行解析和执行。在古老的年代(大约 2007 年以前)，“请求 js/css - 解析执行 - 请求下一个 js/css - 解析执行下一个 js/css” 这样的“串行”操作模式在每次打开页面之前进行着。很明显在解析执行的时候，网络请求是空闲的，这就有了发挥的空间：我们能不能一边解析执行 js/css，一边去请求下一个(或下一批)资源呢？")]),t._v(" "),t._m(18),t._v(" "),a("p",[t._v("而这些被 preloader 请求够来的资源就会被放入 memory cache 中，供之后的解析执行操作使用。")]),t._v(" "),a("p",[t._v("关于preloader详情可以参阅"),a("a",{attrs:{href:"https://calendar.perfplanet.com/2013/big-bad-preloader/",target:"_blank",rel:"noopener noreferrer"}},[t._v("这篇文章"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),t._m(19)]),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),t._m(22),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._v(" "),a("p",[t._v("disk cache 会严格根据HTTP头信息中的各类字段来判定那些资源可以缓存，哪些资源不可以缓存。哪些资源仍然是可用的，哪些资源是过期需要重新请求的。当命中缓存后，浏览器会从硬盘中读取资源，虽然比起从内存中读取慢了一些，但是比起网络请求还是快了不少。绝大部分的缓存都来自disk cache。")]),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),a("p",[t._v("如果一个请求在上述 3 个位置都没有找到缓存，那么浏览器会正式发送网络请求去获取内容。之后容易想到，为了提升之后请求的缓存命中率，自然要把这个资源添加到缓存中去。具体来说：")]),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),a("p",[t._v("强制缓存的含义：当浏览器发送请求后，会先访问缓存数据库看缓存是否存在。如果存在则直接返回；不存在则向服务器发送请求，响应后再写入缓存数据库。")]),t._v(" "),a("p",[t._v("强制缓存直接减少请求数，是提升最大的缓存策略。它的优化覆盖了网络请求的三个步骤：请求、处理、响应。如果考虑使用缓存来优化网页的性能话，强制缓存应该是首先被考虑的。")]),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),a("p",[t._v("Expires是HTTP 1.0 的字段，表示缓存到期时间，是一个绝对的时间(当前时间+缓存时间)，如：")]),t._v(" "),t._m(35),a("p",[t._v("在Google的Chrome浏览的开发者工具中可以看到：")]),t._v(" "),t._m(36),t._v(" "),a("p",[t._v("在响应消息头中，设置这个字段之后，就可以告诉浏览器，在未过期之前不需要再次请求。")]),t._v(" "),a("p",[t._v("设置Expires会有两个缺点：")]),t._v(" "),a("p",[t._v("1、由于设置的是绝对时间，如果用户把电脑的本地时间修改了，可能会导致浏览器判断缓存失效，重新请求该资源。除此之外，时差、误差等因素也可能造成客户端与服务器的时间不一致，导致缓存失效。")]),t._v(" "),a("p",[t._v("2、写法复杂。表示时间的字符串多个空格、少个字母都会导致非法属性从而设置失效。")]),t._v(" "),t._m(37),t._v(" "),t._m(38),t._v(" "),a("p",[t._v("Expires设置的是绝对时间，Cache-Control设置的是相对时间。如：")]),t._v(" "),t._m(39),a("p",[t._v("实际例子见上面图片。")]),t._v(" "),a("p",[t._v("Cache-Control中常用的字段")]),t._v(" "),t._m(40),t._v(" "),a("p",[t._v("更多Cache-Control字段介绍查看"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN"),a("OutboundLink")],1)]),t._v(" "),t._m(41),t._v(" "),t._m(42),t._v(" "),a("p",[a("a",{attrs:{href:"https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"}},[t._v("图片来源"),a("OutboundLink")],1)]),t._v(" "),t._m(43),t._v(" "),t._m(44),t._v(" "),t._m(45),t._v(" "),t._m(46),t._v(" "),t._m(47),t._v(" "),t._m(48),t._v(" "),a("p",[t._v("当强制缓存失效(超过规定时间)时，就需要使用协商缓存，由服务器决定缓存内容是否失效。")]),t._v(" "),a("p",[t._v("协商缓存请求过程：")]),t._v(" "),a("p",[t._v("1、浏览器先请求缓存数据库，返回一个缓存标识。之后浏览器拿着这个标识请求服务器。")]),t._v(" "),a("p",[t._v("2、如果缓存有效，则返回HTTP状态码304标识继续使用缓存。")]),t._v(" "),a("p",[t._v("3、如果缓存失效，则返回新的数据和缓存规则，浏览器收到响应数据后，根据缓存规则存入缓存数据库。")]),t._v(" "),t._m(49),t._v(" "),a("p",[t._v("协商缓存可以和强制缓存一起使用，作为强制缓存失效后的一种候选方案。实际项目经常会一起出现。")]),t._v(" "),t._m(50),t._v(" "),t._m(51),t._v(" "),t._m(52),t._v(" "),t._m(53),a("p",[t._v("2、浏览器将这个值和内容一起记录在缓存数据库中。")]),t._v(" "),t._m(54),t._v(" "),t._m(55),t._v(" "),a("p",[t._v("缺点：")]),t._v(" "),a("p",[t._v("1、如果资源更新的速度是秒以下单位，那么该缓存是不能被使用的，因为它的时间单位最低是秒。")]),t._v(" "),a("p",[t._v("2、如果文件是通过服务器动态生成的，那么该方法的更新时间永远是生成的时间，尽管文件可能没有变化，所以起不到缓存的作用。")]),t._v(" "),t._m(56),t._v(" "),t._m(57),t._v(" "),t._m(58),t._v(" "),t._m(59),t._v(" "),a("p",[t._v("1、优先级上，服务器校验优先考虑Etag。")]),t._v(" "),a("p",[t._v("2、在性能上，Last-Modified优于Etag。因为Last-Modified只需要记录文件最后修改时间，而Etag需要服务器通过算法来计算出资源的唯一标识(hash值)。")]),t._v(" "),a("p",[t._v("3、在精确度上Etag优于Last-Modified。Last-Modified的时间单位是秒，如果资源在1秒内多次修改，那么Last-Modified值没有改变，而Etag每次都会从新生成文件的唯一标识。如果是负载均衡的服务器，则各个服务器生成的Last-Modified也有可能不一致。")]),t._v(" "),t._m(60),t._v(" "),a("p",[t._v("所谓用户行为对浏览器缓存的影响，是指用户对浏览器的操作会触发怎样的缓存策略，主要有如下三种：")]),t._v(" "),t._m(61),t._v(" "),a("p",[t._v("Mac下Google的Chrome浏览器刷新快捷键(cmd + R), 强制刷新快捷键(shift + cmd + R)")]),t._v(" "),t._m(62),t._v(" "),a("p",[t._v("为了应用缓存，现在使用nodejs来搭建一个静态服务器来实际学习缓存。")]),t._v(" "),a("p",[t._v("说明：")]),t._v(" "),t._m(63),t._v(" "),a("p",[t._v("1、首先创建一个文件夹，然后创建如下几个文件：")]),t._v(" "),a("p",[t._v("index.html")]),t._v(" "),t._m(64),a("p",[t._v("index.js")]),t._v(" "),t._m(65),a("p",[t._v("001.png：随便找个图片")]),t._v(" "),a("p",[t._v("server.js")]),t._v(" "),t._m(66),a("p",[t._v("现在文件夹的目录结构：")]),t._v(" "),t._m(67),t._m(68),t._v(" "),t._m(69),t._v(" "),a("p",[t._v("修改server.js文件的processCache方法为如下：")]),t._v(" "),t._m(70),a("p",[t._v("1、修改好文件后，保存，重启node服务。")]),t._v(" "),a("p",[t._v("2、强制刷新一下浏览器，此时查看资源是通过请求获得的。")]),t._v(" "),t._m(71),t._v(" "),a("p",[t._v("4、超过5秒后在刷新，此时可以看到资源又从新发请求了。")]),t._v(" "),a("p",[t._v("注意：index.html 没有使用缓存")]),t._v(" "),t._m(72),t._v(" "),a("p",[t._v("修改server.js文件的processCache方法为如下：")]),t._v(" "),t._m(73),a("p",[t._v("操作步骤跟强缓存Expires实践一样。")]),t._v(" "),a("p",[t._v("注意：index.html 没有使用缓存")]),t._v(" "),t._m(74),t._v(" "),a("p",[t._v("修改server.js文件的processCache方法为如下：")]),t._v(" "),t._m(75),a("p",[t._v("1、修改好文件后，保存，重启node服务。")]),t._v(" "),a("p",[t._v("2、强制刷新一下浏览器，此时查看资源是通过请求获得的。")]),t._v(" "),a("p",[t._v("3、之后每次刷新浏览器，查看资源，返回的状态码都是304，资源使用的是缓存。")]),t._v(" "),t._m(76),t._v(" "),a("p",[t._v("效果如下图所示：")]),t._v(" "),t._m(77),t._v(" "),t._m(78),t._v(" "),a("p",[t._v("修改server.js文件的processCache方法为如下：")]),t._v(" "),t._m(79),a("p",[t._v("操作过程跟 协商缓存Etag一样。")]),t._v(" "),t._m(80),t._v(" "),t._m(81),t._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5c22ee806fb9a049fb43b2c5",target:"_blank",rel:"noopener noreferrer"}},[t._v("一文读懂前端缓存 掘金"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5c136bd16fb9a049d37efc47",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端缓存最佳实践 掘金"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.jianshu.com/p/54cc04190252",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入理解浏览器的缓存机制 简书"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.jb51.net/article/149001.htm",target:"_blank",rel:"noopener noreferrer"}},[t._v("浅谈HTTP 缓存的那些事儿"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000016015363",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTTP缓存理解 segmentfault"),a("OutboundLink")],1)])])},n,!1,null,null,null);c.options.__file="100-浏览器缓存.md";s.default=c.exports}}]);